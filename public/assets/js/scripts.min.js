const CONFIG={CORE:{BASE_WIDTH:1920},ZOOM:{MIN:.5,MAX:5,SENSITIVITY:.001,STEP:.2,SMOOTH:.1},BG:{STAR_COUNT:1e3,STAR_SIZE:{MIN:.5,MAX:2},STAR_ALPHA:{MIN:.2,MAX:1},STAR_TWINKLE_SPEED:.01},SWORD:{COUNT:72,BASE_RADIUS:130,LAYER_SPACING:70,SPIN_SPEED_BASE:.07,ATTACK_DELAY_MS:180,TRAIL_LENGTH:6,SIZE:70,STUN_DURATION_MS:1e3,DURABILITY:10,RESPAWN_DELAY_MS:1e3,DEATH_WAIT_MS:2e3,SPEED_MULT:100,BREATH_SPEED:{MIN:.015,MAX:.025},FLOW_OFFSET:{MIN:40,MAX:100},ATTACK_DELAY_VAR:{BASE:6,RAND:10},FRAGMENTS:{LIFE_TIME:1500,FADE_TIME:500}},INPUT:{DOUBLE_TAP_DELAY:300},COLORS:{BG_FADE:"rgba(0, 0, 8, 0.25)",SWORD_BLADE:["#d0fff5","#7fdcc0","#3fa78a"],SWORD_TRAIL:"rgba(120, 255, 210, 0.3)",SWORD_HANDLE:"#2f7f68",SWORD_GLOW_OUTER:"#8fffe0",SWORD_GLOW_INNER:"#9fffe6",SWORD_FRAGMENT:"#2a5a4d",SWORD_AURA_SHADOW:"#fffaa0",ENEMY_PARTICLE:"#8cf0ff",ENEMY_SHADOW_SHIELD:"#00ffff",SHIELD_GLOW:"rgba(0, 255, 255, 0.8)",SHIELD_RING_PULSE:"rgba(140, 245, 255, 1)",SHIELD_RING_OUTER:"rgba(140, 245, 255, 0.2)"},ENEMY:{SPAWN_COUNT:6,SPAWN_PADDING:50,BASE_SIZE:{MIN:10,VAR:50},HP:{BASE:1,VAR:100},SHIELD_CHANCE:.3,SHIELD_MAX_HP:80,SHIELD_COLOR:"rgba(100, 200, 255, 0.4)",SHIELD_LINE:"#80dfff",DEBRIS:{COUNT:50,SPEED:{MIN:4,MAX:12},SIZE:{MIN:2,MAX:5},LIFE_DECAY:.025},PALETTES:[["#ff9999","#cc3333"],["#99ccff","#3366cc"],["#99ff99","#33cc33"],["#ffcc99","#cc6600"],["#ff99ff","#cc33cc"],["#ffff99","#cccc33"]],HP:{BASE:20,VAR:30},SCALING_FACTOR:.4,PILL_CHANCE:.15,ANIMALS:["./assets/images/animals/ammonite.svg","./assets/images/animals/angel-wings.svg","./assets/images/animals/angler-fish.svg","./assets/images/animals/angular-spider.svg","./assets/images/animals/animal-skull.svg","./assets/images/animals/ant.svg","./assets/images/animals/bear.svg","./assets/images/animals/bee.svg","./assets/images/animals/cat-kitty.svg","./assets/images/animals/cat.svg","./assets/images/animals/crab.svg","./assets/images/animals/crocodile.svg","./assets/images/animals/deer.svg","./assets/images/animals/double-dragon.svg","./assets/images/animals/dragon.svg","./assets/images/animals/elephant.svg","./assets/images/animals/fish-seafood.svg","./assets/images/animals/flying-dragons.svg","./assets/images/animals/fox.svg","./assets/images/animals/gorilla.svg","./assets/images/animals/hydra.svg","./assets/images/animals/jelly-fish.svg","./assets/images/animals/lion.svg","./assets/images/animals/maggot.svg","./assets/images/animals/minotaur.svg","./assets/images/animals/monkey.svg","./assets/images/animals/octopus.svg","./assets/images/animals/perana.svg","./assets/images/animals/rabbit.svg","./assets/images/animals/shark.svg","./assets/images/animals/snail-crawl.svg","./assets/images/animals/squid.svg","./assets/images/animals/squirrel.svg","./assets/images/animals/tapir.svg","./assets/images/animals/three-headed-dragon.svg","./assets/images/animals/tiger.svg","./assets/images/animals/turtle.svg","./assets/images/animals/whale-tail.svg","./assets/images/animals/whale.svg","./assets/images/animals/wolf.svg"]},ITEMS:{PILL_BOOST:.05},MANA:{MAX:100,START:100,REGEN_PER_SEC:1,REGEN_INTERVAL_MS:1e3,COST_RESPAWN:-.2,GAIN_KILL:1,COST_MOVE_PER_SEC:.5,COST_ATTACK_PER_SEC:1,COST_CHANGE_FORM:1},CULTIVATION:{RANKS:[{name:"Luyện khí sơ kỳ (Tầng 1)",exp:5,chance:1,damage:1,maxMana:10,color:"#4CAF50",lightColor:"#A5D6A7"},{name:"Luyện khí sơ kỳ (Tầng 2)",exp:6,chance:.95,damage:2,maxMana:15,color:"#4CAF50",lightColor:"#A5D6A7"},{name:"Luyện khí sơ kỳ (Tầng 3)",exp:7,chance:.95,damage:3,maxMana:20,color:"#4CAF50",lightColor:"#A5D6A7"},{name:"Luyện khí sơ kỳ (Tầng 4)",exp:9,chance:.95,damage:4,maxMana:25,color:"#4CAF50",lightColor:"#A5D6A7"},{name:"Luyện khí trung kỳ (Tầng 5)",exp:12,chance:.9,damage:5,maxMana:30,color:"#43A047",lightColor:"#C8E6C9"},{name:"Luyện khí trung kỳ (Tầng 6)",exp:16,chance:.9,damage:6,maxMana:35,color:"#43A047",lightColor:"#C8E6C9"},{name:"Luyện khí trung kỳ (Tầng 7)",exp:21,chance:.9,damage:7,maxMana:40,color:"#43A047",lightColor:"#C8E6C9"},{name:"Luyện khí trung kỳ (Tầng 8)",exp:27,chance:.9,damage:8,maxMana:45,color:"#43A047",lightColor:"#C8E6C9"},{name:"Luyện khí hậu kỳ (Tầng 9)",exp:35,chance:.85,damage:9,maxMana:50,color:"#2E7D32",lightColor:"#E8F5E9"},{name:"Luyện khí hậu kỳ (Tầng 10)",exp:45,chance:.85,damage:10,maxMana:55,color:"#2E7D32",lightColor:"#E8F5E9"},{name:"Luyện khí hậu kỳ (Tầng 11)",exp:58,chance:.85,damage:11,maxMana:60,color:"#2E7D32",lightColor:"#E8F5E9"},{name:"Luyện khí hậu kỳ (Tầng 12)",exp:75,chance:.8,damage:12,maxMana:65,color:"#2E7D32",lightColor:"#E8F5E9"},{name:"Luyện khí đại viên mãn (Tầng 13)",exp:100,chance:.75,damage:13,maxMana:70,bonus:100,color:"#1B5E20",lightColor:"#FFFFFF"},{name:"Trúc cơ sơ kỳ",exp:120,chance:.7,damage:14,maxMana:75,color:"#2196F3",lightColor:"#90CAF9"},{name:"Trúc cơ trung kỳ",exp:180,chance:.65,damage:15,maxMana:80,color:"#1E88E5",lightColor:"#BBDEFB"},{name:"Trúc cơ hậu kỳ",exp:270,chance:.6,damage:16,maxMana:85,color:"#1565C0",lightColor:"#E3F2FD"},{name:"Trúc cơ đại viên mãn",exp:400,chance:.55,damage:17,maxMana:90,bonus:300,color:"#0D47A1",lightColor:"#FFFFFF"},{name:"Kết đan sơ kỳ",exp:600,chance:.5,damage:18,maxMana:95,color:"#FF9800",lightColor:"#FFCC80"},{name:"Kết đan trung kỳ",exp:900,chance:.45,damage:19,maxMana:100,color:"#FB8C00",lightColor:"#FFE0B2"},{name:"Kết đan hậu kỳ",exp:1400,chance:.4,damage:20,maxMana:105,color:"#EF6C00",lightColor:"#FFF3E0"},{name:"Kết đan đại viên mãn",exp:2e3,chance:.35,damage:21,maxMana:110,bonus:1500,color:"#E65100",lightColor:"#FFFFFF"},{name:"Nguyên anh sơ kỳ",exp:3e3,chance:.35,damage:22,maxMana:105,color:"#E91E63",lightColor:"#F48FB1"},{name:"Nguyên anh trung kỳ",exp:5e3,chance:.3,damage:23,maxMana:120,color:"#D81B60",lightColor:"#F8BBD0"},{name:"Nguyên anh hậu kỳ",exp:8e3,chance:.25,damage:24,maxMana:125,color:"#C2185B",lightColor:"#FCE4EC"},{name:"Nguyên anh đại viên mãn",exp:12e3,chance:.2,damage:25,maxMana:130,bonus:8e3,color:"#880E4F",lightColor:"#FFFFFF"},{name:"Hóa thần sơ kỳ",exp:18e3,chance:.2,damage:26,maxMana:135,color:"#9C27B0",lightColor:"#CE93D8"},{name:"Hóa thần trung kỳ",exp:25e3,chance:.18,damage:27,maxMana:140,color:"#8E24AA",lightColor:"#E1BEE7"},{name:"Hóa thần hậu kỳ",exp:35e3,chance:.15,damage:28,maxMana:145,color:"#7B1FA2",lightColor:"#F3E5F5"},{name:"Hóa thần đại viên mãn",exp:5e4,chance:.12,damage:29,maxMana:150,bonus:25e3,color:"#4A148C",lightColor:"#FFFFFF"},{name:"Luyện hư sơ kỳ",exp:6e4,chance:.12,damage:30,maxMana:155,color:"#3F51B5",lightColor:"#9FA8DA"},{name:"Luyện hư trung kỳ",exp:8e4,chance:.1,damage:31,maxMana:160,color:"#3949AB",lightColor:"#C5CAE9"},{name:"Luyện hư hậu kỳ",exp:11e4,chance:.09,damage:32,maxMana:165,color:"#303F9F",lightColor:"#E8EAF6"},{name:"Luyện hư đại viên mãn",exp:15e4,chance:.08,damage:33,maxMana:170,bonus:3e4,color:"#1A237E",lightColor:"#FFFFFF"},{name:"Hợp thể sơ kỳ",exp:14e4,chance:.08,damage:34,maxMana:175,color:"#00BCD4",lightColor:"#80DEEA"},{name:"Hợp thể trung kỳ",exp:18e4,chance:.07,damage:35,maxMana:180,color:"#00ACC1",lightColor:"#B2EBF2"},{name:"Hợp thể hậu kỳ",exp:23e4,chance:.06,damage:36,maxMana:185,color:"#0097A7",lightColor:"#E0F7FA"},{name:"Hợp thể đại viên mãn",exp:3e5,chance:.05,damage:37,maxMana:190,bonus:5e4,color:"#006064",lightColor:"#FFFFFF"},{name:"Đại thừa sơ kỳ",exp:3e5,chance:.05,damage:38,maxMana:195,color:"#F44336",lightColor:"#EF9A9A"},{name:"Đại thừa trung kỳ",exp:38e4,chance:.04,damage:39,maxMana:200,color:"#E53935",lightColor:"#FFCDD2"},{name:"Đại thừa hậu kỳ",exp:48e4,chance:.03,damage:40,maxMana:205,color:"#D32F2F",lightColor:"#FFEBEE"},{name:"Đại thừa đại viên mãn",exp:6e5,chance:.02,damage:41,maxMana:210,bonus:8e4,color:"#B71C1C",lightColor:"#FFFFFF"},{name:"Chân tiên sơ kỳ",exp:6e5,chance:.02,damage:42,maxMana:215,color:"#FFD700",lightColor:"#FFF59D"},{name:"Chân tiên trung kỳ",exp:75e4,chance:.015,damage:43,maxMana:220,color:"#FFC107",lightColor:"#FFF9C4"},{name:"Chân tiên hậu kỳ",exp:95e4,chance:.01,damage:44,maxMana:225,color:"#FFA000",lightColor:"#FFFDE7"},{name:"Chân tiên đại viên mãn",exp:999999999,chance:0,damage:45,maxMana:230,color:"#FF8F00",lightColor:"#FFFFFF"}]}},random=(a,t)=>Math.random()*(t-a)+a,enemyIcons={};function preloadEnemyIcons(){CONFIG.ENEMY.ANIMALS.forEach(a=>{const t=new Image;t.src=a;const e=a.split("/").pop().split(".")[0];enemyIcons[e]=t})}preloadEnemyIcons();class Enemy{constructor(){this.particles=[],this.respawn()}respawn(){const a=Camera.currentZoom,t=window.innerWidth/a,e=window.innerHeight/a,s=window.innerWidth/2-t/2,n=window.innerHeight/2-e/2,i=CONFIG.ENEMY.SPAWN_PADDING;this.x=random(s+i,s+t-i),this.y=random(n+i,n+e-i),this.particles=[],this.cracks=[],this.shieldLevel=0;const o=CONFIG.ENEMY.ANIMALS,h=o[Math.floor(Math.random()*o.length)];this.icon=new Image,this.icon.src=h,this.rotation=Math.random()*Math.PI*2;const r=Input.rankIndex||0,l=Math.max(0,Math.min(CONFIG.CULTIVATION.RANKS.length-1,r+Math.floor(3*Math.random())-1));this.rankData=CONFIG.CULTIVATION.RANKS[l],this.rankName=this.rankData.name,this.colors=[this.rankData.lightColor,this.rankData.color];const c=CONFIG.ENEMY.BASE_SIZE.MIN+1.5*l,m=CONFIG.ENEMY.BASE_SIZE.VAR;this.r=(c+Math.pow(Math.random(),1.5)*m)*(window.innerWidth/CONFIG.CORE.BASE_WIDTH);this.maxHp=Math.floor(2.5*this.rankData.maxMana*(.9+.2*Math.random())),this.hp=this.maxHp,this.hasShield=Math.random()<CONFIG.ENEMY.SHIELD_CHANCE+.005*l,this.hasShield?(this.shieldHp=Math.floor(.4*this.hp),this.maxShieldHp=this.shieldHp):(this.shieldHp=0,this.maxShieldHp=0)}generateCracks(a){const t=this.r+10,e=Math.random()*Math.PI*2,s=5+2*a,n=[];for(let a=0;a<s;a++){const i=e+a*Math.PI*2/s,o=[],h=4;for(let a=0;a<=h;a++){const e=t*a/h,s=0===a?0:.2*(Math.random()-.5);o.push({x:Math.cos(i+s)*e,y:Math.sin(i+s)*e})}this.cracks.push(o),n.push(o)}const i=2+a;for(let a=1;a<=i;a++){const t=Math.floor((n[0].length-1)*(a/(i+1)));for(let a=0;a<n.length;a++){const e=(a+1)%n.length,s=n[a][t],i=n[e][t];Math.random()>.2&&this.cracks.push([s,i])}}}hit(a){const t=CONFIG.CULTIVATION.RANKS[Input.rankIndex],e=t?t.damage:1;if(this.hasShield&&this.shieldHp>0){this.shieldHp-=e;let a=Math.floor((this.maxShieldHp-this.shieldHp)/20);return a>this.shieldLevel&&(this.shieldLevel=a,this.cracks=[],this.generateCracks(this.shieldLevel)),this.shieldHp<=0&&(this.hasShield=!1,this.createShieldDebris()),"shielded"}if(this.hp-=e,this.hp<=0){const a=Math.max(1,this.r/(window.innerWidth/CONFIG.CORE.BASE_WIDTH*15)),t=1+2*Input.rankIndex,e=Math.ceil(2*a*t);return Input.updateExp(e),Input.updateMana(Math.ceil(CONFIG.MANA.GAIN_KILL*a)),Math.random()<CONFIG.ENEMY.PILL_CHANCE&&(Input.pillCount++,showNotify("+1 Linh Đan (Tăng tỉ lệ đột phá)","#00ffcc"),Input.createLevelUpExplosion(this.x,this.y,"#00ffcc")),this.respawn(),"killed"}return"hit"}drawShield(a,t){const e=(this.r+10)*t,s=.1*Math.sin(.006*Date.now())+.9;a.save(),a.beginPath(),a.arc(0,0,e,0,2*Math.PI),a.strokeStyle=`rgba(140, 245, 255, ${.5*s})`,a.lineWidth=2*t,a.stroke(),this.cracks.length>0&&(a.beginPath(),a.strokeStyle="rgba(255, 255, 255, 0.5)",a.lineWidth=1*t,this.cracks.forEach(e=>{if(!(e.length<2)){a.moveTo(e[0].x*t,e[0].y*t);for(let s=1;s<e.length;s++)a.lineTo(e[s].x*t,e[s].y*t)}}),a.stroke()),a.restore()}createShieldDebris(){const a=CONFIG.ENEMY.DEBRIS;for(let t=0;t<a.COUNT;t++){const t=Math.random()*Math.PI*2,e=random(a.SPEED.MIN,a.SPEED.MAX);visualParticles.push({x:this.x,y:this.y,vx:Math.cos(t)*e,vy:Math.sin(t)*e,size:random(a.SIZE.MIN,a.SIZE.MAX),life:1,color:CONFIG.COLORS.ENEMY_PARTICLE,type:"square"})}}draw(a,t){a.save(),a.translate(this.x,this.y),this.drawParticles(a,t),this.hasShield&&this.drawShield(a,t),this.drawBody(a,t),a.fillStyle="rgba(255, 255, 255, 0.8)",a.font=`bold ${11*t}px "Segoe UI", Arial`,a.textAlign="center",a.shadowColor="black",a.shadowBlur=4*t;const e=-this.r-(this.hasShield?15:10)*t;a.fillText(this.rankName,0,e),a.restore()}drawParticles(a,t){const e=CONFIG.ENEMY.DEBRIS.LIFE_DECAY;for(let s=this.particles.length-1;s>=0;s--){let n=this.particles[s];if(n.x+=n.vx,n.y+=n.vy,n.life-=e,n.life<=0){this.particles.splice(s,1);continue}a.save(),a.translate(n.x*t,n.y*t),a.rotate(n.rotation+=n.spin),a.globalAlpha=n.life,a.fillStyle=CONFIG.COLORS.ENEMY_PARTICLE;const i=n.size*t;a.fillRect(-i/2,-i/2,i,i),a.restore()}}drawBody(a,t){a.save();const e=a.createRadialGradient(0,0,0,0,0,1.2*this.r);if(e.addColorStop(0,this.colors[1]+"66"),e.addColorStop(1,"transparent"),a.beginPath(),a.arc(0,0,1.2*this.r,0,2*Math.PI),a.fillStyle=e,a.fill(),this.icon&&this.icon.complete){const e=2*this.r*t;a.drawImage(this.icon,-e/2,-e/2,e,e)}a.restore()}}class Sword{constructor(a,t){this.index=a,this.layer=Math.floor(a/24),this.baseAngle=2*Math.PI/24*(a%24),this.spinAngle=0,this.spinSpeed=CONFIG.SWORD.SPIN_SPEED_BASE/(this.layer+1)*(this.layer%2?-1:1),this.radius=(CONFIG.SWORD.BASE_RADIUS+this.layer*CONFIG.SWORD.LAYER_SPACING)*t,this.x=window.innerWidth/2,this.y=window.innerHeight/2,this.vx=0,this.vy=0,this.drawAngle=0,this.trail=[],this.breath=random(0,2*Math.PI),this.breathSpeed=random(CONFIG.SWORD.BREATH_SPEED.MIN,CONFIG.SWORD.BREATH_SPEED.MAX),this.attackDelay=this.layer*CONFIG.SWORD.ATTACK_DELAY_VAR.BASE+random(0,CONFIG.SWORD.ATTACK_DELAY_VAR.RAND),this.attackFrame=0,this.flowNoise=Math.random()*Math.PI*2,this.flowOffsetAngle=2*Math.PI/72*a,this.flowOffsetRadius=(CONFIG.SWORD.FLOW_OFFSET.MIN+Math.random()*(CONFIG.SWORD.FLOW_OFFSET.MAX-CONFIG.SWORD.FLOW_OFFSET.MIN))*t,this.isStunned=!1,this.stunTimer=0,this.maxHp=CONFIG.SWORD.DURABILITY||3,this.hp=this.maxHp,this.isDead=!1,this.respawnTimer=0,this.fragments=[],this.deathTime=0}update(a,t,e,s){if(this.isDead){const a=performance.now();return void(a>this.respawnTimer&&(e.mana>=Math.abs(CONFIG.MANA.COST_RESPAWN)?(e.updateMana(CONFIG.MANA.COST_RESPAWN),this.respawn(e)):this.respawnTimer=a+1e3))}if(this.isStunned)return void this.handleStun(s);this.breath+=this.breathSpeed,this.breathSpeed=random(CONFIG.SWORD.BREATH_SPEED.MIN,CONFIG.SWORD.BREATH_SPEED.MAX);const n=this.radius+8*Math.sin(this.breath)*s;e.isAttacking?this.updateAttackMode(t,e,s):this.updateGuardMode(a,n,e,s)}handleStun(a){this.x+=this.vx,this.y+=this.vy,this.vx*=.95,this.vy*=.95,this.drawAngle+=.2,this.trail.push({x:this.x,y:this.y}),this.trail.length>CONFIG.SWORD.TRAIL_LENGTH&&this.trail.shift(),performance.now()>this.stunTimer&&(this.isStunned=!1,this.vx*=.2,this.vy*=.2)}respawn(a){this.isDead=!1,this.hp=this.maxHp,this.x=a.x,this.y=a.y,this.vx=0,this.vy=0,this.isStunned=!1,this.trail=[],this.fragments=[]}updateGuardMode(a,t,e,s){const n=performance.now()/1e3*this.spinSpeed*(CONFIG.SWORD.SPEED_MULT||100),i=this.baseAngle+n,o=a.x+Math.cos(i)*t,h=a.y+Math.sin(i)*t;if(e.speed>1.5){const a=o-this.x,t=h-this.y,e=Math.hypot(a,t)||1;this.vx+=a/e*Math.min(.05*e,4*s),this.vy+=t/e*Math.min(.05*e,4*s),this.vx*=.85,this.vy*=.85,this.x+=this.vx,this.y+=this.vy,this.drawAngle=Math.atan2(this.vy,this.vx)+Math.PI/2}else{const a=o-this.x,t=h-this.y;this.x+=.12*a,this.y+=.12*t,this.vx*=.5,this.vy*=.5,Math.hypot(a,t)<.5&&(this.x=o,this.y=h);let s=(1===e.guardForm?i+Math.PI/2:Math.atan2(h-this.y,o-this.x)+Math.PI/2)-this.drawAngle;for(;s<-Math.PI;)s+=2*Math.PI;for(;s>Math.PI;)s-=2*Math.PI;this.drawAngle+=.15*s}this.attackFrame=0,this.trail=[]}updateAttackMode(a,t,e){if(this.attackFrame++,this.attackFrame<this.attackDelay)return;let s=null,n=1/0;for(const e of a){const a=Math.hypot(e.x-t.x,e.y-t.y);a<n&&(n=a,s=e)}if(s){const a=s.x-this.x,t=s.y-this.y,n=Math.hypot(a,t)||1;if(this.vx+=a/n*10*e,this.vy+=t/n*10*e,this.vx*=.92,this.vy*=.92,this.x+=this.vx,this.y+=this.vy,this.drawAngle=Math.atan2(this.vy,this.vx)+Math.PI/2,Math.hypot(this.x-s.x,this.y-s.y)<s.r+(s.hasShield?10:0)){"shielded"===s.hit(this)&&(this.hp--,this.hp<=0?this.breakSword(e):(this.isStunned=!0,this.stunTimer=performance.now()+CONFIG.SWORD.STUN_DURATION_MS,this.vx=1.5*-this.vx+10*(Math.random()-.5),this.vy=1.5*-this.vy+10*(Math.random()-.5)))}this.trail.push({x:this.x,y:this.y}),this.trail.length>CONFIG.SWORD.TRAIL_LENGTH&&this.trail.shift()}}breakSword(a){this.isDead=!0,this.deathTime=performance.now(),this.respawnTimer=this.deathTime+CONFIG.SWORD.DEATH_WAIT_MS+CONFIG.SWORD.RESPAWN_DELAY_MS;const t=CONFIG.SWORD.SIZE*a,e=Math.cos(this.drawAngle),s=Math.sin(this.drawAngle);this.fragments.push({type:"handle",x:this.x,y:this.y,vx:.2*-this.vx+random(-1,1),vy:.2*-this.vy+random(-1,1),angle:this.drawAngle,va:random(-.1,.1)}),this.fragments.push({type:"mid",x:this.x+e*(.4*t)+s*(.4*t),y:this.y+s*(.4*t)-e*(.4*t),vx:.4*-this.vx+random(-2,2),vy:.4*-this.vy+random(-2,2),angle:this.drawAngle+random(-.2,.2),va:random(-.2,.2)}),this.fragments.push({type:"tip",x:this.x+e*(.8*t)+s*(.8*t),y:this.y+s*(.8*t)-e*(.8*t),vx:.6*-this.vx+random(-3,3),vy:.6*-this.vy+random(-3,3),angle:this.drawAngle+random(-.5,.5),va:random(-.4,.4)})}draw(a,t){if(this.isDead){if(this.fragments.length>0){const e=performance.now()-this.deathTime,s=CONFIG.SWORD.FRAGMENTS.LIFE_TIME,n=CONFIG.SWORD.FRAGMENTS.FADE_TIME,i=e>s?1-(e-s)/n:1;a.save(),a.globalAlpha=i,this.drawFragments(a,t),a.restore()}}else{if(this.trail.length>1){a.beginPath(),a.moveTo(this.trail[0].x,this.trail[0].y);for(let t=1;t<this.trail.length;t++)a.lineTo(this.trail[t].x,this.trail[t].y);a.strokeStyle=CONFIG.COLORS.SWORD_TRAIL,a.lineWidth=2*t,a.stroke()}a.save(),a.translate(this.x,this.y),a.rotate(this.drawAngle),this.drawAura(a,t),this.drawBlade(a,t),a.restore()}}drawFragments(a,t){const e=CONFIG.SWORD.SIZE*t,s=4*t;this.fragments.forEach(n=>{n.x+=n.vx,n.y+=n.vy,n.angle+=n.va,a.save(),a.translate(n.x,n.y),a.rotate(n.angle),a.shadowBlur=0,a.shadowColor="transparent",a.beginPath(),"handle"===n.type?(a.fillStyle=CONFIG.COLORS.SWORD_HANDLE,a.fillRect(-3*t,0,6*t,14*t),a.fillStyle=CONFIG.COLORS.SWORD_BLADE[2],a.moveTo(-s/2,0),a.lineTo(s/2,0),a.lineTo(s/2,.3*-e),a.lineTo(0,.2*-e),a.lineTo(-s/2,.35*-e),a.fill()):"mid"===n.type?(a.fillStyle=CONFIG.COLORS.SWORD_BLADE[1],a.moveTo(-s/2,0),a.lineTo(s/2,0),a.lineTo(s/2,.3*-e),a.lineTo(-s/2,.25*-e),a.fill()):"tip"===n.type&&(a.fillStyle=CONFIG.COLORS.SWORD_BLADE[0],a.moveTo(-s/2,0),a.lineTo(s/2,0),a.lineTo(0,.4*-e),a.fill()),a.restore()})}drawAura(a,t){const e=Math.floor(random(2,4));a.shadowColor=CONFIG.COLORS.SWORD_AURA_SHADOW,a.shadowBlur=8*t;for(let s=0;s<e;s++){a.beginPath();let e=-random(0,CONFIG.SWORD.SIZE*t),s=random(-3,3)*t;a.moveTo(s,e);for(let n=0;n<3;n++)s+=random(-4,4)*t,e+=random(-3,3)*t,a.lineTo(s,e);a.strokeStyle=`rgba(255,255,180,${random(.3,.6)})`,a.lineWidth=1.5*t,a.stroke()}}drawBlade(a,t){const e=CONFIG.SWORD.SIZE*t,s=4*t;a.shadowColor=CONFIG.COLORS.SWORD_GLOW_OUTER,a.shadowBlur=15*t;const n=a.createLinearGradient(0,-e,0,0);n.addColorStop(0,CONFIG.COLORS.SWORD_BLADE[0]),n.addColorStop(.5,CONFIG.COLORS.SWORD_BLADE[1]),n.addColorStop(1,CONFIG.COLORS.SWORD_BLADE[2]),a.fillStyle=n,a.beginPath(),a.moveTo(-s/2,0),a.lineTo(-s/2,-e),a.quadraticCurveTo(0,-e-10*t,s/2,-e),a.lineTo(s/2,0),a.fill(),a.shadowColor=CONFIG.COLORS.SWORD_GLOW_INNER,a.fillStyle=CONFIG.COLORS.SWORD_FRAGMENT,a.beginPath(),a.roundRect(-7*t,-1.2*t,14*t,2.4*t,2.4*t),a.fill(),a.fillStyle=CONFIG.COLORS.SWORD_HANDLE,a.beginPath(),a.moveTo(-3*t,0),a.lineTo(-2*t,14*t),a.lineTo(2*t,14*t),a.lineTo(3*t,0),a.fill()}}class StarField{constructor(a,t,e){this.stars=[];const s=CONFIG.BG.STAR_COUNT||a;for(let a=0;a<s;a++)this.stars.push({x:random(-t,2*t),y:random(-e,2*e),r:random(CONFIG.BG.STAR_SIZE.MIN,CONFIG.BG.STAR_SIZE.MAX),alpha:random(CONFIG.BG.STAR_ALPHA.MIN,CONFIG.BG.STAR_ALPHA.MAX)})}draw(a,t){a.shadowBlur=0;const e=CONFIG.BG.STAR_TWINKLE_SPEED;for(const s of this.stars)s.alpha+=random(-e,e),s.alpha>CONFIG.BG.STAR_ALPHA.MAX?s.alpha=CONFIG.BG.STAR_ALPHA.MAX:s.alpha<CONFIG.BG.STAR_ALPHA.MIN&&(s.alpha=CONFIG.BG.STAR_ALPHA.MIN),a.beginPath(),a.arc(s.x,s.y,s.r*t,0,2*Math.PI),a.fillStyle=`rgba(255,255,255,${s.alpha})`,a.fill()}}const canvas=document.getElementById("c"),ctx=canvas.getContext("2d",{alpha:!1});let width,height,scaleFactor=1,frameCount=0,lastTime=performance.now(),visualParticles=[];function showNotify(a,t){let e=document.getElementById("game-notification");e||(e=document.createElement("div"),e.id="game-notification",document.body.appendChild(e)),e.children.length>2&&e.removeChild(e.firstChild);const s=document.createElement("div");s.className="notify-item",s.innerText=a,s.style.color=t,s.style.borderLeft=`3px solid ${t}`,e.appendChild(s),setTimeout(()=>{s.remove()},2500)}const Camera={currentZoom:1,targetZoom:1,update(){this.currentZoom+=(this.targetZoom-this.currentZoom)*CONFIG.ZOOM.SMOOTH},adjustZoom(a){this.targetZoom=Math.max(CONFIG.ZOOM.MIN,Math.min(CONFIG.ZOOM.MAX,this.targetZoom+a))},screenToWorld(a,t){const e=width/2,s=height/2;return{x:(a-e)/this.currentZoom+e,y:(t-s)/this.currentZoom+s}}};function resize(){width=canvas.width=window.innerWidth,height=canvas.height=window.innerHeight,scaleFactor=width/CONFIG.CORE.BASE_WIDTH}window.addEventListener("resize",resize),resize();const Input={screenX:width/2,screenY:height/2,x:width/2,y:height/2,px:0,py:0,speed:0,isAttacking:!1,guardForm:1,attackTimer:null,isTouchDevice:"ontouchstart"in window||navigator.maxTouchPoints>0,mana:CONFIG.MANA.START||100,maxMana:CONFIG.MANA.MAX||100,lastManaRegenTick:performance.now(),initialPinchDist:0,lastFrameTime:performance.now(),exp:0,rankIndex:0,pillCount:0,isReadyToBreak:!1,processActiveConsumption(a){let t=0;this.speed>1&&(t+=CONFIG.MANA.COST_MOVE_PER_SEC*a),this.isAttacking&&(t+=CONFIG.MANA.COST_ATTACK_PER_SEC*a),t>0&&(this.mana>0?this.updateMana(-t):this.isAttacking&&(this.isAttacking=!1,this.triggerManaShake()))},updateMana(a){this.mana=Math.max(0,Math.min(this.maxMana,this.mana+a)),this.renderManaUI()},regenMana(){const a=performance.now(),t=a-this.lastManaRegenTick;if(t>=CONFIG.MANA.REGEN_INTERVAL_MS){const e=Math.floor(t/CONFIG.MANA.REGEN_INTERVAL_MS);e>0&&(this.updateMana(e*CONFIG.MANA.REGEN_PER_SEC),this.lastManaRegenTick=a-t%CONFIG.MANA.REGEN_INTERVAL_MS)}},renderManaUI(){const a=document.getElementById("mana-bar"),t=document.getElementById("mana-text");if(a&&t){const e=this.mana/this.maxMana*100;a.style.width=e+"%",t.innerText=`Linh lực: ${Math.round(this.mana)}/${this.maxMana}`,e<20?a.classList.add("low-mana"):a.classList.remove("low-mana")}},triggerManaShake(){const a=document.getElementById("mana-container");a.classList.remove("mana-shake","mana-empty-error"),a.offsetWidth,a.classList.add("mana-shake","mana-empty-error"),setTimeout(()=>{a.classList.remove("mana-shake","mana-empty-error")},500)},updateExp(a){this.isReadyToBreak||(this.exp+=a,this.checkLevelUp()),this.renderExpUI()},checkLevelUp(){const a=CONFIG.CULTIVATION.RANKS[this.rankIndex];a&&this.exp>=a.exp&&!this.isReadyToBreak&&(this.isReadyToBreak=!0,showNotify("Linh khí tràn đầy, sẵn sàng đột phá!","#00ffcc"))},executeBreakthrough(){const a=CONFIG.CULTIVATION.RANKS[this.rankIndex];if(!a)return;let t=a.chance+this.pillCount*CONFIG.ITEMS.PILL_BOOST;if(t=Math.min(.95,t),Math.random()<=t){this.exp=0,this.rankIndex++,this.isReadyToBreak=!1,this.pillCount=0;const t=CONFIG.CULTIVATION.RANKS[this.rankIndex];t&&(t.maxMana&&(this.maxMana=t.maxMana),this.mana=this.maxMana,showNotify(`ĐỘT PHÁ THÀNH CÔNG: ${t.name.toUpperCase()}`,"#ffcc00")),this.createLevelUpExplosion(this.x,this.y,a.color)}else{const a=Math.floor(.4*this.exp);this.exp-=a,this.isReadyToBreak=!1,this.pillCount=Math.floor(this.pillCount/2),showNotify("ĐỘT PHÁ THẤT BẠI! Tâm ma phản phệ (-40% tu vi)","#ff4444"),this.triggerExpError()}this.renderExpUI(),this.renderManaUI()},renderExpUI(){const a=CONFIG.CULTIVATION.RANKS[this.rankIndex];if(!a)return;a.maxMana&&(this.maxMana=a.maxMana);const t=document.getElementById("exp-bar"),e=document.getElementById("exp-text"),s=document.getElementById("cultivation-rank"),n=document.querySelector(".breakthrough-group"),i=(100*a.chance).toFixed(0),o=(this.pillCount*CONFIG.ITEMS.PILL_BOOST*100).toFixed(0),h=Math.min(95,parseFloat(i)+parseFloat(o));e&&(this.isReadyToBreak?e.innerHTML=`<span style="color:#ffcc00; font-weight:bold;">SẴN SÀNG ĐỘT PHÁ</span> | <span style="color:#00ffcc">Linh Đan: ${this.pillCount}</span> (<span style="color:#ffcc00">TL: ${h}%</span>)`:e.innerHTML=`Tu vi: ${Math.floor(this.exp)}/${a.exp} | <span style="color:#00ffcc">Linh Đan: ${this.pillCount}</span> (<span style="color:#ffcc00">TL: ${h}%</span>)`),n&&(this.isReadyToBreak?n.classList.add("is-active"):n.classList.remove("is-active"));const r=this.exp/a.exp*100;t&&(t.style.width=Math.min(100,r)+"%",t.style.background=`linear-gradient(90deg, ${a.lightColor}, ${a.color})`,this.isReadyToBreak?(t.style.boxShadow=`0 0 15px #fff, 0 0 5px ${a.color}`,t.classList.add("exp-full-glow")):(t.style.boxShadow=`0 0 10px ${a.lightColor}`,t.classList.remove("exp-full-glow"))),s&&(s.innerText=`Cảnh giới: ${a.name}`,s.style.color=a.color)},triggerExpError(){const a=document.getElementById("exp-container");a.classList.add("shake-red"),setTimeout(()=>a.classList.remove("shake-red"),500)},update(a){const t=Camera.screenToWorld(this.screenX,this.screenY);this.x=t.x,this.y=t.y,this.speed=Math.hypot(this.x-this.px,this.y-this.py),this.px=this.x,this.py=this.y,this.processActiveConsumption(a)},handleMove(a){if(a.target.closest(".btn"))return;const t=a.touches?a.touches[0]:a;this.screenX=t.clientX,this.screenY=t.clientY},handleDown(a){a.target.closest(".btn")||this.isTouchDevice||(a.preventDefault(),this.attackTimer=setTimeout(()=>{this.isAttacking=!0},CONFIG.SWORD.ATTACK_DELAY_MS))},handleUp(a){this.isTouchDevice||(this.isAttacking=!1,clearTimeout(this.attackTimer))},handleWheel(a){const t=-a.deltaY*CONFIG.ZOOM.SENSITIVITY;Camera.adjustZoom(t)},createLevelUpExplosion(a,t,e){for(let s=0;s<30;s++)visualParticles.push({x:a,y:t,vx:8*(Math.random()-.5),vy:8*(Math.random()-.5),size:3*Math.random()+1,life:1,color:e||"#fff"})}};window.addEventListener("pointermove",a=>{a.touches||Input.handleMove(a)}),window.addEventListener("pointerdown",a=>Input.handleDown(a)),window.addEventListener("pointerup",a=>Input.handleUp(a)),window.addEventListener("wheel",a=>{Camera.adjustZoom(-a.deltaY*CONFIG.ZOOM.SENSITIVITY)},{passive:!1}),window.addEventListener("keydown",a=>{"+"!==a.key&&"="!==a.key||Camera.adjustZoom(CONFIG.ZOOM.STEP),"-"!==a.key&&"_"!==a.key||Camera.adjustZoom(-CONFIG.ZOOM.STEP)}),window.addEventListener("touchstart",a=>{2===a.touches.length&&(Input.initialPinchDist=Math.hypot(a.touches[0].clientX-a.touches[1].clientX,a.touches[0].clientY-a.touches[1].clientY))},{passive:!1}),window.addEventListener("touchmove",a=>{if(2===a.touches.length){a.preventDefault();const t=Math.hypot(a.touches[0].clientX-a.touches[1].clientX,a.touches[0].clientY-a.touches[1].clientY),e=.01*(t-Input.initialPinchDist);Camera.adjustZoom(e),Input.initialPinchDist=t}else Input.handleMove(a)},{passive:!1}),document.getElementById("btn-form").addEventListener("pointerdown",a=>{a.stopPropagation(),a.preventDefault();const t=CONFIG.MANA.COST_CHANGE_FORM;if(Input.mana>=t){Input.updateMana(-t),Input.guardForm=1===Input.guardForm?2:1;const e=a.currentTarget.querySelector(".icon-form");e&&(e.style.transform=`rotate(${1===Input.guardForm?-15:165}deg)`)}else Input.triggerManaShake()}),document.getElementById("btn-breakthrough").addEventListener("pointerdown",a=>{a.stopPropagation(),Input.executeBreakthrough()});const attackBtn=document.getElementById("btn-attack"),startAttack=a=>{a.stopPropagation(),a.preventDefault();const t=swords.filter(a=>!a.isDead).length;if(Input.mana<=0&&0===t)return Input.triggerManaShake(),void(Input.isAttacking=!1);Input.isAttacking=!0},stopAttack=a=>{a.stopPropagation(),a.preventDefault(),Input.isAttacking=!1,Input.attackTimer&&clearTimeout(Input.attackTimer)};attackBtn.addEventListener("pointerdown",startAttack),attackBtn.addEventListener("pointerup",stopAttack),attackBtn.addEventListener("pointerleave",stopAttack);const enemies=[],swords=[];let starField;const guardCenter={x:width/2,y:height/2,vx:0,vy:0};function init(){const a=CONFIG.CULTIVATION.RANKS[Input.rankIndex];Input.maxMana=a.maxMana||CONFIG.MANA.MAX,Input.mana=Input.maxMana,Input.renderManaUI(),Input.renderExpUI(),starField=new StarField(250,width,height);for(let a=0;a<CONFIG.ENEMY.SPAWN_COUNT;a++)enemies.push(new Enemy);for(let a=0;a<CONFIG.SWORD.COUNT;a++)swords.push(new Sword(a,scaleFactor))}function updateSwordCounter(a){const t=a.filter(a=>!a.isDead).length,e=a.length,s=document.getElementById("sword-count-text");s&&(s.innerText=`${t}/${e}`,s.style.color=t<.3*e?"#ff4444":"#fff")}function updatePhysics(a){Camera.update(),Input.update(a),Input.regenMana();let t=Input.x-guardCenter.x,e=Input.y-guardCenter.y;guardCenter.vx+=.04*t,guardCenter.vy+=.04*e,guardCenter.vx*=.82,guardCenter.vy*=.82,guardCenter.x+=guardCenter.vx,guardCenter.y+=guardCenter.vy}function renderCursor(){ctx.shadowBlur=10,ctx.shadowColor="#6fffe0",ctx.beginPath(),ctx.arc(Input.x,Input.y,4*scaleFactor,0,2*Math.PI),ctx.fillStyle="#6fffe0",ctx.fill(),ctx.shadowBlur=0}function animate(){const a=performance.now(),t=(a-lastTime)/1e3;lastTime=a,frameCount++,ctx.fillStyle=CONFIG.COLORS.BG_FADE,ctx.fillRect(0,0,width,height),updatePhysics(t),frameCount%10==0&&updateSwordCounter(swords),ctx.save(),ctx.translate(width/2,height/2),ctx.scale(Camera.currentZoom,Camera.currentZoom),ctx.translate(-width/2,-height/2),starField.draw(ctx,scaleFactor),ctx.save(),ctx.translate(guardCenter.x,guardCenter.y),ctx.rotate(2e-4*performance.now()),ctx.strokeStyle="rgba(120,255,210,0.1)",ctx.lineWidth=1.5*scaleFactor,ctx.beginPath(),ctx.arc(0,0,50*scaleFactor,0,2*Math.PI),ctx.stroke(),ctx.restore(),enemies.forEach(a=>a.draw(ctx,scaleFactor)),swords.forEach(a=>{a.update(guardCenter,enemies,Input,scaleFactor),a.draw(ctx,scaleFactor)}),renderCursor(),visualParticles.forEach((a,t)=>{a.x+=a.vx,a.y+=a.vy,a.life-=.02,ctx.globalAlpha=a.life,ctx.fillStyle=a.color,ctx.beginPath(),ctx.arc(a.x,a.y,a.size,0,2*Math.PI),ctx.fill(),a.life<=0&&visualParticles.splice(t,1)}),ctx.globalAlpha=1,ctx.restore(),requestAnimationFrame(animate)}init(),animate();