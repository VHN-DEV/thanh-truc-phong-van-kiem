const CONFIG={CORE:{BASE_WIDTH:1920},ZOOM:{MIN:.5,MAX:5,SENSITIVITY:.001,STEP:.2,SMOOTH:.1},BG:{STAR_COUNT:1e3,STAR_SIZE:{MIN:.5,MAX:2},STAR_ALPHA:{MIN:.2,MAX:1},STAR_TWINKLE_SPEED:.01},SWORD:{COUNT:72,BASE_RADIUS:130,LAYER_SPACING:70,SPIN_SPEED_BASE:.07,ATTACK_DELAY_MS:180,TRAIL_LENGTH:6,SIZE:70,STUN_DURATION_MS:1e3,RESPAWN_DELAY_MS:1500,DEATH_WAIT_MS:2e3,SPEED_MULT:90,BREATH_SPEED:{MIN:.015,MAX:.025},FLOW_OFFSET:{MIN:40,MAX:100},ATTACK_DELAY_VAR:{BASE:6,RAND:10},FRAGMENTS:{LIFE_TIME:2e3,FADE_TIME:1e3}},INPUT:{DOUBLE_TAP_DELAY:300},COLORS:{BG_FADE:"rgba(0, 0, 8, 0.25)",SWORD_BLADE:["#d0fff5","#7fdcc0","#3fa78a"],SWORD_TRAIL:"rgba(120, 255, 210, 0.3)",SWORD_HANDLE:"#2f7f68",SWORD_GLOW_OUTER:"#8fffe0",SWORD_GLOW_INNER:"#9fffe6",SWORD_FRAGMENT:"#2a5a4d",SWORD_AURA_SHADOW:"#fffaa0",ENEMY_PARTICLE:"#8cf0ff",ENEMY_SHADOW_SHIELD:"#00ffff",SHIELD_GLOW:"rgba(0, 255, 255, 0.8)",SHIELD_RING_PULSE:"rgba(140, 245, 255, 1)",SHIELD_RING_OUTER:"rgba(140, 245, 255, 0.2)"},ENEMY:{SPAWN_COUNT:10,SPAWN_PADDING:50,ELITE_MULT:5,ELITE_CHANCE:.01,BASE_SIZE:{MIN:10,VAR:50},GUARANTEED_PLAYER_SCALE_COUNT:1,GUARANTEED_COUNT:3,DIFF_LIMIT:6,MAJOR_RANK_DIFF:9,NOTIFY_COOLDOWN_MS:3e3,SPAWN_RANK_RANGE:{MIN_ID:1,MAX_ID:45},SHIELD_CHANCE:.3,SHIELD_COLOR:"rgba(100, 200, 255, 0.4)",SHIELD_LINE:"#80dfff",SHIELD_HP_RATIO:.1,RECOVERY_DELAY_MS:3e3,RECOVERY_SPEED_PER_SEC:.05,DEBRIS:{COUNT:10,SPEED:{MIN:4,MAX:12},SIZE:{MIN:1,MAX:3},LIFE_DECAY:.025},PALETTES:[["#ff9999","#cc3333"],["#99ccff","#3366cc"],["#99ff99","#33cc33"],["#ffcc99","#cc6600"],["#ff99ff","#cc33cc"],["#ffff99","#cccc33"]],ANIMALS:["./assets/images/animals/ammonite.svg","./assets/images/animals/angel-wings.svg","./assets/images/animals/angler-fish.svg","./assets/images/animals/angular-spider.svg","./assets/images/animals/animal-skull.svg","./assets/images/animals/ant.svg","./assets/images/animals/bear.svg","./assets/images/animals/bee.svg","./assets/images/animals/cat-kitty.svg","./assets/images/animals/cat.svg","./assets/images/animals/crab.svg","./assets/images/animals/crocodile.svg","./assets/images/animals/deer.svg","./assets/images/animals/double-dragon.svg","./assets/images/animals/dragon.svg","./assets/images/animals/elephant.svg","./assets/images/animals/fish-seafood.svg","./assets/images/animals/flying-dragon.svg","./assets/images/animals/fox.svg","./assets/images/animals/gorilla.svg","./assets/images/animals/hydra.svg","./assets/images/animals/jelly-fish.svg","./assets/images/animals/lion.svg","./assets/images/animals/maggot.svg","./assets/images/animals/minotaur.svg","./assets/images/animals/monkey.svg","./assets/images/animals/octopus.svg","./assets/images/animals/perana.svg","./assets/images/animals/rabbit.svg","./assets/images/animals/shark.svg","./assets/images/animals/snail-crawl.svg","./assets/images/animals/squid.svg","./assets/images/animals/squirrel.svg","./assets/images/animals/tapir.svg","./assets/images/animals/three-headed-dragon.svg","./assets/images/animals/tiger.svg","./assets/images/animals/turtle.svg","./assets/images/animals/whale-tail.svg","./assets/images/animals/whale.svg","./assets/images/animals/wolf.svg"]},ITEMS:{PILL_BOOST:.05},MANA:{MAX:100,START:100,REGEN_PER_SEC:2,REGEN_INTERVAL_MS:1e3,COST_RESPAWN:-3,GAIN_KILL:0,COST_MOVE_PER_SEC:.5,COST_ATTACK_PER_SEC:1,COST_CHANGE_FORM:1},CULTIVATION:{MAX_BREAKTHROUGH_CHANCE:.99,BREAKTHROUGH_PENALTY_FACTOR:.4,OVERFLOW_LIMIT:1.2,RANKS:[{id:1,name:"Luyện khí sơ kỳ (Tầng 1)",exp:5,expGive:1,chance:1,swordDurability:3,damage:1,hp:1e3,maxMana:10,color:"#4CAF50",lightColor:"#A5D6A7"},{id:2,name:"Luyện khí sơ kỳ (Tầng 2)",exp:6,expGive:1,chance:.95,swordDurability:4,damage:2,hp:1100,maxMana:15,color:"#4CAF50",lightColor:"#A5D6A7"},{id:3,name:"Luyện khí sơ kỳ (Tầng 3)",exp:7,expGive:1,chance:.95,swordDurability:5,damage:3,hp:1200,maxMana:20,color:"#4CAF50",lightColor:"#A5D6A7"},{id:4,name:"Luyện khí sơ kỳ (Tầng 4)",exp:9,expGive:2,chance:.95,swordDurability:6,damage:4,hp:1300,maxMana:25,color:"#4CAF50",lightColor:"#A5D6A7"},{id:5,name:"Luyện khí trung kỳ (Tầng 5)",exp:12,expGive:2,chance:.9,swordDurability:7,damage:5,hp:1400,maxMana:30,color:"#43A047",lightColor:"#C8E6C9"},{id:6,name:"Luyện khí trung kỳ (Tầng 6)",exp:16,expGive:3,chance:.9,swordDurability:8,damage:6,hp:1500,maxMana:35,color:"#43A047",lightColor:"#C8E6C9"},{id:7,name:"Luyện khí trung kỳ (Tầng 7)",exp:21,expGive:4,chance:.9,swordDurability:9,damage:7,hp:1600,maxMana:40,color:"#43A047",lightColor:"#C8E6C9"},{id:8,name:"Luyện khí trung kỳ (Tầng 8)",exp:27,expGive:5,chance:.9,swordDurability:10,damage:8,hp:1700,maxMana:45,color:"#43A047",lightColor:"#C8E6C9"},{id:9,name:"Luyện khí hậu kỳ (Tầng 9)",exp:35,expGive:7,chance:.85,swordDurability:11,damage:9,hp:1800,maxMana:50,color:"#2E7D32",lightColor:"#E8F5E9"},{id:10,name:"Luyện khí hậu kỳ (Tầng 10)",exp:45,expGive:9,chance:.85,swordDurability:12,damage:10,hp:1900,maxMana:55,color:"#2E7D32",lightColor:"#E8F5E9"},{id:11,name:"Luyện khí hậu kỳ (Tầng 11)",exp:58,expGive:12,chance:.85,swordDurability:13,damage:11,hp:2e3,maxMana:60,color:"#2E7D32",lightColor:"#E8F5E9"},{id:12,name:"Luyện khí hậu kỳ (Tầng 12)",exp:75,expGive:15,chance:.8,swordDurability:14,damage:12,hp:2100,maxMana:65,color:"#2E7D32",lightColor:"#E8F5E9"},{id:13,name:"Luyện khí đại viên mãn (Tầng 13)",exp:100,expGive:20,chance:.75,swordDurability:15,damage:13,hp:2200,maxMana:70,bonus:100,color:"#1B5E20",lightColor:"#FFFFFF"},{id:14,name:"Trúc cơ sơ kỳ",exp:120,expGive:25,chance:.7,swordDurability:16,damage:14,hp:2300,maxMana:75,color:"#2196F3",lightColor:"#90CAF9"},{id:15,name:"Trúc cơ trung kỳ",exp:180,expGive:35,chance:.65,swordDurability:17,damage:15,hp:2400,maxMana:80,color:"#1E88E5",lightColor:"#BBDEFB"},{id:16,name:"Trúc cơ hậu kỳ",exp:270,expGive:50,chance:.6,swordDurability:18,damage:16,hp:2500,maxMana:85,color:"#1565C0",lightColor:"#E3F2FD"},{id:17,name:"Trúc cơ đại viên mãn",exp:400,expGive:80,chance:.55,swordDurability:19,damage:17,hp:2600,maxMana:90,bonus:300,color:"#0D47A1",lightColor:"#FFFFFF"},{id:18,name:"Kết đan sơ kỳ",exp:600,expGive:120,chance:.5,swordDurability:20,damage:18,hp:2700,maxMana:95,color:"#FF9800",lightColor:"#FFCC80"},{id:19,name:"Kết đan trung kỳ",exp:900,expGive:180,chance:.45,swordDurability:21,damage:19,hp:2800,maxMana:100,color:"#FB8C00",lightColor:"#FFE0B2"},{id:20,name:"Kết đan hậu kỳ",exp:1400,expGive:280,chance:.4,swordDurability:22,damage:20,hp:2900,maxMana:105,color:"#EF6C00",lightColor:"#FFF3E0"},{id:21,name:"Kết đan đại viên mãn",exp:2e3,expGive:400,chance:.35,swordDurability:23,damage:21,hp:3e3,maxMana:110,bonus:1500,color:"#E65100",lightColor:"#FFFFFF"},{id:22,name:"Nguyên anh sơ kỳ",exp:3e3,expGive:600,chance:.35,swordDurability:24,damage:22,hp:3100,maxMana:105,color:"#E91E63",lightColor:"#F48FB1"},{id:23,name:"Nguyên anh trung kỳ",exp:5e3,expGive:1e3,chance:.3,swordDurability:25,damage:23,hp:3200,maxMana:120,color:"#D81B60",lightColor:"#F8BBD0"},{id:24,name:"Nguyên anh hậu kỳ",exp:8e3,expGive:1600,chance:.25,swordDurability:26,damage:24,hp:3300,maxMana:125,color:"#C2185B",lightColor:"#FCE4EC"},{id:25,name:"Nguyên anh đại viên mãn",exp:12e3,expGive:2500,chance:.2,swordDurability:27,damage:25,hp:3400,maxMana:130,bonus:8e3,color:"#880E4F",lightColor:"#FFFFFF"},{id:26,name:"Hóa thần sơ kỳ",exp:18e3,expGive:3600,chance:.2,swordDurability:28,damage:26,hp:3500,maxMana:135,color:"#9C27B0",lightColor:"#CE93D8"},{id:27,name:"Hóa thần trung kỳ",exp:25e3,expGive:5e3,chance:.18,swordDurability:29,damage:27,hp:3600,maxMana:140,color:"#8E24AA",lightColor:"#E1BEE7"},{id:28,name:"Hóa thần hậu kỳ",exp:35e3,expGive:7e3,chance:.15,swordDurability:30,damage:28,hp:3700,maxMana:145,color:"#7B1FA2",lightColor:"#F3E5F5"},{id:29,name:"Hóa thần đại viên mãn",exp:5e4,expGive:1e4,chance:.12,swordDurability:31,damage:29,hp:3800,maxMana:150,bonus:25e3,color:"#4A148C",lightColor:"#FFFFFF"},{id:30,name:"Luyện hư sơ kỳ",exp:6e4,expGive:12e3,chance:.12,swordDurability:32,damage:30,hp:3900,maxMana:155,color:"#3F51B5",lightColor:"#9FA8DA"},{id:31,name:"Luyện hư trung kỳ",exp:8e4,expGive:16e3,chance:.1,swordDurability:33,damage:31,hp:4e3,maxMana:160,color:"#3949AB",lightColor:"#C5CAE9"},{id:32,name:"Luyện hư hậu kỳ",exp:11e4,expGive:22e3,chance:.09,swordDurability:34,damage:32,hp:4100,maxMana:165,color:"#303F9F",lightColor:"#E8EAF6"},{id:33,name:"Luyện hư đại viên mãn",exp:15e4,expGive:3e4,chance:.08,swordDurability:35,damage:33,hp:4200,maxMana:170,bonus:3e4,color:"#1A237E",lightColor:"#FFFFFF"},{id:34,name:"Hợp thể sơ kỳ",exp:14e4,expGive:28e3,chance:.08,swordDurability:36,damage:34,hp:4300,maxMana:175,color:"#00BCD4",lightColor:"#80DEEA"},{id:35,name:"Hợp thể trung kỳ",exp:18e4,expGive:36e3,chance:.07,swordDurability:37,damage:35,hp:4400,maxMana:180,color:"#00ACC1",lightColor:"#B2EBF2"},{id:36,name:"Hợp thể hậu kỳ",exp:23e4,expGive:46e3,chance:.06,swordDurability:38,damage:36,hp:4500,maxMana:185,color:"#0097A7",lightColor:"#E0F7FA"},{id:37,name:"Hợp thể đại viên mãn",exp:3e5,expGive:6e4,chance:.05,swordDurability:39,damage:37,hp:4600,maxMana:190,bonus:5e4,color:"#006064",lightColor:"#FFFFFF"},{id:38,name:"Đại thừa sơ kỳ",exp:3e5,expGive:6e4,chance:.05,swordDurability:40,damage:38,hp:4700,maxMana:195,color:"#F44336",lightColor:"#EF9A9A"},{id:39,name:"Đại thừa trung kỳ",exp:38e4,expGive:76e3,chance:.04,swordDurability:41,damage:39,hp:4800,maxMana:200,color:"#E53935",lightColor:"#FFCDD2"},{id:40,name:"Đại thừa hậu kỳ",exp:48e4,expGive:96e3,chance:.03,swordDurability:42,damage:40,hp:4900,maxMana:205,color:"#D32F2F",lightColor:"#FFEBEE"},{id:41,name:"Đại thừa đại viên mãn",exp:6e5,expGive:12e4,chance:.02,swordDurability:43,damage:41,hp:5e3,maxMana:210,bonus:8e4,color:"#B71C1C",lightColor:"#FFFFFF"},{id:42,name:"Chân tiên sơ kỳ",exp:6e5,expGive:12e4,chance:.02,swordDurability:44,damage:42,hp:5100,maxMana:215,color:"#FFD700",lightColor:"#FFF59D"},{id:43,name:"Chân tiên trung kỳ",exp:75e4,expGive:15e4,chance:.015,swordDurability:49,damage:43,hp:5200,maxMana:220,color:"#FFC107",lightColor:"#FFF9C4"},{id:44,name:"Chân tiên hậu kỳ",exp:95e4,expGive:19e4,chance:.01,swordDurability:46,damage:44,hp:5500,maxMana:225,color:"#FFA000",lightColor:"#FFFDE7"},{id:45,name:"Chân tiên đại viên mãn",exp:999999999,expGive:0,chance:0,swordDurability:9999,damage:9999,hp:99999,maxMana:9999,color:"#FF8F00",lightColor:"#FFFFFF"}]},PILL:{CHANCE:.15,ELITE_CHANCE:1,COLLECT_DELAY_MS:600,MAGNET_SPEED:14,TRAIL_LENGTH:15,DROP_RATES:{NORMAL:{LOW:.85,MEDIUM:.1,HIGH:.05},ELITE:{LOW:.1,MEDIUM:.6,HIGH:.3}},DROP_COUNT:{NORMAL:1,ELITE:3},TYPES:{LOW:{name:"Hạ phẩm",boost:.02,color:"#00ffcc",radius:4},MEDIUM:{name:"Trung phẩm",boost:.05,color:"#00aaff",radius:5.5},HIGH:{name:"Thượng phẩm",boost:.12,color:"#ffcc00",radius:7.5}}}},random=(t,e)=>Math.random()*(e-t)+t;class Enemy{constructor(){this.particles=[],this.angle=Math.random()*Math.PI*2,this.velocity={x:0,y:0},this.floatOffset=1e3*Math.random(),this.wanderSpeed=this.isElite?.8:.4,this.respawn()}respawn(){const t=Camera.currentZoom,e=window.innerWidth/t,a=window.innerHeight/t,i=window.innerWidth/2-e/2,s=window.innerHeight/2-a/2,n=CONFIG.ENEMY.SPAWN_PADDING;this.lastHitTime=0,this.lastNotifyTime=0,this.x=random(i+n,i+e-n),this.y=random(s+n,s+a-n),this.particles=[],this.cracks=[],this.shieldLevel=0;const o=Input.rankIndex||0,h=CONFIG.ENEMY.DIFF_LIMIT||3,r=enemies.filter(t=>{if(t===this||!t.rankData)return!1;return CONFIG.CULTIVATION.RANKS.findIndex(e=>e.id===t.rankData.id)-o<h}).length<2;let l;if(this.isElite=Math.random()<CONFIG.ENEMY.ELITE_CHANCE,r){const t=h-1,e=-1,a=Math.floor(Math.random()*(t-e+1))+e;l=Math.max(0,Math.min(CONFIG.CULTIVATION.RANKS.length-1,o+a)),this.isElite=!1}else if(this.isElite)l=Math.min(CONFIG.CULTIVATION.RANKS.length-1,o+2);else{const{MIN_ID:t,MAX_ID:e}=CONFIG.ENEMY.SPAWN_RANK_RANGE,a=this.getRandomRankById(t,e);l=CONFIG.CULTIVATION.RANKS.findIndex(t=>t.id===(a?a.id:1)),-1===l&&(l=0)}this.rankData=CONFIG.CULTIVATION.RANKS[l],this.rankName=(this.isElite?"★ TINH ANH ★ ":"")+this.rankData.name,this.colors=[this.rankData.lightColor,this.rankData.color];const c=this.rankData.hp||1e3,d=this.isElite?4:1;this.maxHp=Math.floor(c*(1+.05*Math.random())*d),this.hp=this.maxHp;const m=this.isElite?1.8:1;if(this.r=(CONFIG.ENEMY.BASE_SIZE.MIN+Math.random()*CONFIG.ENEMY.BASE_SIZE.VAR)*m,this.hasShield=Math.random()<CONFIG.ENEMY.SHIELD_CHANCE+(this.isElite?.4:0),this.hasShield&&(this.shieldHp=Math.floor(this.hp*(CONFIG.ENEMY.SHIELD_HP_RATIO||.5)),this.maxShieldHp=this.shieldHp),this.wanderSpeed=(this.isElite?.8:.4)*(this.rankData.speedMult||1),CONFIG.ENEMY.ANIMALS){const t=CONFIG.ENEMY.ANIMALS[Math.floor(Math.random()*CONFIG.ENEMY.ANIMALS.length)].split("/").pop().split(".")[0];this.icon=enemyIcons[t]}}getRandomRankById(t,e){const a=CONFIG.CULTIVATION.RANKS.filter(a=>a.id>=t&&a.id<=e);return 0===a.length?(console.warn("Không tìm thấy cảnh giới trong khoảng id:",t,e),null):a[Math.floor(Math.random()*a.length)]}updateMovement(t){const e=.001*Date.now();this.angle+=.02*Math.sin(e+this.floatOffset);const a=this.wanderSpeed*t;this.velocity.x=Math.cos(this.angle)*a,this.velocity.y=Math.sin(this.angle)*a,this.x+=this.velocity.x,this.y+=this.velocity.y;const i=50*t;(this.x<i||this.x>window.innerWidth-i)&&(this.angle=Math.PI-this.angle),(this.y<i||this.y>window.innerHeight-i)&&(this.angle=-this.angle)}generateCracks(t){const e=this.r+12,a=Math.random()*Math.PI*2,i=5+2*t,s=[];this.cracks=[];for(let t=0;t<i;t++){const n=a+t*Math.PI*2/i,o=[],h=4;for(let t=0;t<=h;t++){const a=e*t/h,i=0===t?0:.2*(Math.random()-.5);o.push({x:Math.cos(n+i)*a,y:Math.sin(n+i)*a})}this.cracks.push(o),s.push(o)}const n=2+t;for(let t=1;t<=n;t++){const e=Math.floor((s[0].length-1)*(t/(n+1)));for(let t=0;t<s.length;t++){const a=(t+1)%s.length,i=s[t][e],n=s[a][e];Math.random()>.2&&this.cracks.push([i,n])}}}hit(t){const e=Input.rankIndex||0,a=CONFIG.CULTIVATION.RANKS.indexOf(this.rankData)-e,i=Date.now(),s=CONFIG.CULTIVATION.RANKS[e],n=s?s.damage:1;let o=Math.ceil(n*(t?.powerPenalty||1));if(a>=CONFIG.ENEMY.MAJOR_RANK_DIFF?(o=0,i-(this.lastNotifyTime||0)>CONFIG.ENEMY.NOTIFY_COOLDOWN_MS&&(showNotify("BẤT TỬ: Tu vi quá chênh lệch!","#ff0000"),this.lastNotifyTime=i)):a>=CONFIG.ENEMY.DIFF_LIMIT&&(o=1,i-(this.lastNotifyTime||0)>CONFIG.ENEMY.NOTIFY_COOLDOWN_MS&&(showNotify("NÉ TRÁNH: Cấp bậc áp chế!","#ffcc00"),this.lastNotifyTime=i)),this.lastHitTime=Date.now(),this.hasShield&&this.shieldHp>0){this.shieldHp-=o;let t=Math.floor((this.maxShieldHp-this.shieldHp)/this.maxShieldHp*5);return t>this.shieldLevel&&(this.shieldLevel=t,this.cracks=[],this.generateCracks(this.shieldLevel)),this.shieldHp<=0&&(this.hasShield=!1,this.createShieldDebris()),"shielded"}if(this.hp-=o,this.hp<=0){const t=this.isElite?CONFIG.ENEMY.ELITE_MULT:1;let e=(this.rankData.expGive||1)*t,a=CONFIG.MANA.GAIN_KILL*t;this.isElite&&showNotify("DIỆT TINH ANH: THU HOẠCH LỚN!","#ffcc00"),Input.updateExp(e),Input.updateMana(a);const i=CONFIG.PILL,s=this.isElite?i.ELITE_CHANCE:i.CHANCE;if(Math.random()<s){const t=this.isElite?i.DROP_RATES.ELITE:i.DROP_RATES.NORMAL,e=this.isElite?i.DROP_COUNT.ELITE:i.DROP_COUNT.NORMAL;for(let a=0;a<e;a++){let e="LOW";const a=Math.random();e=a<t.HIGH?"HIGH":a<t.HIGH+t.MEDIUM?"MEDIUM":"LOW",pills.push(new Pill(this.x,this.y,e))}showNotify(this.isElite?"Đại cơ duyên! Linh Đan xuất thế!":"Thu hoạch Linh Đan",this.isElite?"#ffcc00":"#00ffcc")}return this.respawn(),"killed"}return 0===o?"immune":"hit"}drawShield(t,e){const a=(this.r+12)*e,i=.05*Math.sin(.006*Date.now())+1;t.save();const s=t.createRadialGradient(0,0,this.r*e,0,0,a);s.addColorStop(0,"rgba(140, 245, 255, 0)"),s.addColorStop(1,"rgba(140, 245, 255, 0.2)"),t.fillStyle=s,t.beginPath(),t.arc(0,0,a*i,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(0,0,a*i,0,2*Math.PI),t.strokeStyle=`rgba(140, 245, 255, ${.6*(2-i)})`,t.lineWidth=2*e,t.stroke(),this.cracks.length>0&&(t.beginPath(),t.strokeStyle="rgba(255, 255, 255, 0.6)",t.lineWidth=1*e,this.cracks.forEach(a=>{if(!(a.length<2)){t.moveTo(a[0].x*e*i,a[0].y*e*i);for(let s=1;s<a.length;s++)t.lineTo(a[s].x*e*i,a[s].y*e*i)}}),t.stroke()),t.restore()}createShieldDebris(){const t=CONFIG.ENEMY.DEBRIS;for(let e=0;e<t.COUNT;e++){const e=Math.random()*Math.PI*2,a=random(t.SPEED.MIN,t.SPEED.MAX);visualParticles.push({x:this.x,y:this.y,vx:Math.cos(e)*a,vy:Math.sin(e)*a,size:random(t.SIZE.MIN,t.SIZE.MAX),life:1,color:CONFIG.COLORS.ENEMY_PARTICLE,type:"square"})}}updateShieldRecovery(){if(!this.hasShield||this.shieldHp<=0)return;if(this.shieldHp>=this.maxShieldHp)return;if(Date.now()-this.lastHitTime>CONFIG.ENEMY.RECOVERY_DELAY_MS){this.shieldHp=Math.min(this.maxShieldHp,this.shieldHp+this.maxShieldHp*CONFIG.ENEMY.RECOVERY_SPEED_PER_SEC);let t=Math.floor((this.maxShieldHp-this.shieldHp)/this.maxShieldHp*5);t<this.shieldLevel&&(this.shieldLevel=t,this.cracks=[],this.shieldLevel>0&&this.generateCracks(this.shieldLevel))}}draw(t,e){this.updateMovement(e),this.updateShieldRecovery();const a=Date.now(),i=1+.05*Math.sin(.002*a+this.floatOffset),s=this.rankData.color;t.save(),t.translate(this.x,this.y),t.save(),t.scale(i,i),this.drawParticles(t,e),this.hasShield&&this.drawShield(t,e),this.drawBody(t,e),t.restore(),t.fillStyle=s,t.font=`bold ${11*e}px "Segoe UI", Arial`,t.textAlign="center",this.isElite&&(t.shadowColor=s,t.shadowBlur=8*e);const n=-this.r-(this.hasShield?15:10)*e;t.fillText(this.rankName,0,n),t.shadowBlur=0;const o=1.5*this.r*e,h=4*e,r=n+5*e;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(-o/2,r,o,h);const l=Math.max(0,this.hp/this.maxHp);t.fillStyle=s,t.fillRect(-o/2,r,o*l,h),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=.5*e,t.strokeRect(-o/2,r,o,h),t.restore()}drawParticles(t,e){const a=CONFIG.ENEMY.DEBRIS.LIFE_DECAY;for(let i=this.particles.length-1;i>=0;i--){let s=this.particles[i];if(s.x+=s.vx,s.y+=s.vy,s.life-=a,s.life<=0){this.particles.splice(i,1);continue}t.save(),t.translate(s.x*e,s.y*e),t.rotate(s.rotation+=s.spin),t.globalAlpha=s.life,t.fillStyle=CONFIG.COLORS.ENEMY_PARTICLE;const n=s.size*e;t.fillRect(-n/2,-n/2,n,n),t.restore()}}drawBody(t,e){if(!this.r||isNaN(this.r))return;t.save(),this.isElite&&(t.shadowColor="#ff3300",t.shadowBlur=20*e,t.translate(2*(Math.random()-.5),2*(Math.random()-.5)));const a=t.createRadialGradient(0,0,0,0,0,1.3*this.r);if(a.addColorStop(0,this.colors[1]+"55"),a.addColorStop(1,"transparent"),t.fillStyle=a,t.beginPath(),t.arc(0,0,1.3*this.r,0,2*Math.PI),t.fill(),this.icon&&this.icon.complete&&this.icon.naturalWidth>0){const a=1.5*this.r*e;t.shadowColor=this.colors[1],t.shadowBlur=10*e,t.drawImage(this.icon,-a/2,-a/2,a,a)}else t.beginPath(),t.arc(0,0,this.r*e,0,2*Math.PI),t.fillStyle=this.colors[1],t.fill();t.restore()}}class Sword{constructor(t,e){this.index=t,this.layer=Math.floor(t/24),this.baseAngle=2*Math.PI/24*(t%24),this.spinAngle=0,this.spinSpeed=CONFIG.SWORD.SPIN_SPEED_BASE/(this.layer+1)*(this.layer%2?-1:1),this.radius=(CONFIG.SWORD.BASE_RADIUS+this.layer*CONFIG.SWORD.LAYER_SPACING)*e,this.x=window.innerWidth/2,this.y=window.innerHeight/2,this.vx=0,this.vy=0,this.drawAngle=0,this.trail=[],this.breath=random(0,2*Math.PI),this.breathSpeed=random(CONFIG.SWORD.BREATH_SPEED.MIN,CONFIG.SWORD.BREATH_SPEED.MAX),this.attackDelay=this.layer*CONFIG.SWORD.ATTACK_DELAY_VAR.BASE+random(0,CONFIG.SWORD.ATTACK_DELAY_VAR.RAND),this.attackFrame=0,this.flowNoise=Math.random()*Math.PI*2,this.flowOffsetAngle=2*Math.PI/72*t,this.flowOffsetRadius=(CONFIG.SWORD.FLOW_OFFSET.MIN+Math.random()*(CONFIG.SWORD.FLOW_OFFSET.MAX-CONFIG.SWORD.FLOW_OFFSET.MIN))*e,this.isStunned=!1,this.stunTimer=0;const a=CONFIG.CULTIVATION.RANKS[Input.rankIndex]||CONFIG.CULTIVATION.RANKS[0];this.maxHp=a.swordDurability,this.hp=this.maxHp,this.isDead=!1,this.respawnTimer=0,this.fragments=[],this.deathTime=0,this.powerPenalty=1}update(t,e,a,i){if(this.isDead){const t=performance.now();return void(t>this.respawnTimer&&(a.mana>=Math.abs(CONFIG.MANA.COST_RESPAWN)?(a.updateMana(CONFIG.MANA.COST_RESPAWN),this.respawn(a)):this.respawnTimer=t+1e3))}if(this.isStunned)return void this.handleStun(i);this.breath+=this.breathSpeed,this.breathSpeed=random(CONFIG.SWORD.BREATH_SPEED.MIN,CONFIG.SWORD.BREATH_SPEED.MAX);const s=this.radius+8*Math.sin(this.breath)*i;a.isAttacking?this.updateAttackMode(e,a,i):this.updateGuardMode(t,s,a,i)}handleStun(t){this.x+=this.vx,this.y+=this.vy,this.vx*=.95,this.vy*=.95,this.drawAngle+=.2,this.trail.push({x:this.x,y:this.y}),this.trail.length>CONFIG.SWORD.TRAIL_LENGTH&&this.trail.shift(),performance.now()>this.stunTimer&&(this.isStunned=!1,this.vx*=.2,this.vy*=.2)}respawn(t){const e=CONFIG.CULTIVATION.RANKS[t.rankIndex]||CONFIG.CULTIVATION.RANKS[0];this.maxHp=e.swordDurability,this.hp=this.maxHp,this.isDead=!1,this.x=t.x,this.y=t.y,this.vx=0,this.vy=0,this.isStunned=!1,this.trail=[],this.fragments=[]}updateGuardMode(t,e,a,i){const s=performance.now()/1e3*this.spinSpeed*(CONFIG.SWORD.SPEED_MULT||100),n=this.baseAngle+s,o=t.x+Math.cos(n)*e,h=t.y+Math.sin(n)*e;if(a.speed>1.5){const t=o-this.x,e=h-this.y,a=Math.hypot(t,e)||1;this.vx+=t/a*Math.min(.05*a,4*i),this.vy+=e/a*Math.min(.05*a,4*i),this.vx*=.85,this.vy*=.85,this.x+=this.vx,this.y+=this.vy,this.drawAngle=Math.atan2(this.vy,this.vx)+Math.PI/2}else{const t=o-this.x,e=h-this.y;this.x+=.12*t,this.y+=.12*e,this.vx*=.5,this.vy*=.5,Math.hypot(t,e)<.5&&(this.x=o,this.y=h);let i=(1===a.guardForm?n+Math.PI/2:Math.atan2(h-this.y,o-this.x)+Math.PI/2)-this.drawAngle;for(;i<-Math.PI;)i+=2*Math.PI;for(;i>Math.PI;)i-=2*Math.PI;this.drawAngle+=.15*i}this.attackFrame=0,this.trail=[]}updateAttackMode(t,e,a){if(this.attackFrame++,this.attackFrame<this.attackDelay)return;const i=this.hp/this.maxHp;this.powerPenalty=.6+.4*i;let s=null,n=1/0;for(const a of t){const t=Math.hypot(a.x-e.x,a.y-e.y);t<n&&(n=t,s=a)}if(s){const t=s.x-this.x,e=s.y-this.y,i=Math.hypot(t,e)||1;if(this.vx+=t/i*10*a,this.vy+=e/i*10*a,this.vx*=.92,this.vy*=.92,this.x+=this.vx,this.y+=this.vy,this.drawAngle=Math.atan2(this.vy,this.vx)+Math.PI/2,Math.hypot(this.x-s.x,this.y-s.y)<s.r+(s.hasShield?10:0)){"shielded"===s.hit(this)&&(this.hp-=s.isElite?3:1,this.hp<=0?this.breakSword(a):(this.isStunned=!0,this.stunTimer=performance.now()+CONFIG.SWORD.STUN_DURATION_MS,this.vx=1.5*-this.vx+10*(Math.random()-.5),this.vy=1.5*-this.vy+10*(Math.random()-.5)))}this.trail.push({x:this.x,y:this.y}),this.trail.length>CONFIG.SWORD.TRAIL_LENGTH&&this.trail.shift()}}breakSword(t){this.isDead=!0,this.deathTime=performance.now(),this.respawnTimer=this.deathTime+CONFIG.SWORD.DEATH_WAIT_MS+CONFIG.SWORD.RESPAWN_DELAY_MS;const e=CONFIG.SWORD.SIZE*t,a=Math.cos(this.drawAngle),i=Math.sin(this.drawAngle);this.fragments.push({type:"handle",x:this.x,y:this.y,vx:.2*-this.vx+random(-1,1),vy:.2*-this.vy+random(-1,1),angle:this.drawAngle,va:random(-.1,.1)}),this.fragments.push({type:"mid",x:this.x+a*(.4*e)+i*(.4*e),y:this.y+i*(.4*e)-a*(.4*e),vx:.4*-this.vx+random(-2,2),vy:.4*-this.vy+random(-2,2),angle:this.drawAngle+random(-.2,.2),va:random(-.2,.2)}),this.fragments.push({type:"tip",x:this.x+a*(.8*e)+i*(.8*e),y:this.y+i*(.8*e)-a*(.8*e),vx:.6*-this.vx+random(-3,3),vy:.6*-this.vy+random(-3,3),angle:this.drawAngle+random(-.5,.5),va:random(-.4,.4)})}draw(t,e){if(this.isDead){if(this.fragments.length>0){const a=performance.now()-this.deathTime,i=CONFIG.SWORD.FRAGMENTS.LIFE_TIME,s=CONFIG.SWORD.FRAGMENTS.FADE_TIME,n=a>i?1-(a-i)/s:1;t.save(),t.globalAlpha=n,this.drawFragments(t,e),t.restore()}}else{if(this.trail.length>1){t.beginPath(),t.moveTo(this.trail[0].x,this.trail[0].y);for(let e=1;e<this.trail.length;e++)t.lineTo(this.trail[e].x,this.trail[e].y);t.strokeStyle=CONFIG.COLORS.SWORD_TRAIL,t.lineWidth=2*e,t.stroke()}t.save(),t.translate(this.x,this.y),t.rotate(this.drawAngle),this.drawAura(t,e),this.drawBlade(t,e),t.restore()}}drawFragments(t,e){const a=CONFIG.SWORD.SIZE*e,i=4*e;this.fragments.forEach(s=>{s.x+=s.vx,s.y+=s.vy,s.angle+=s.va,t.save(),t.translate(s.x,s.y),t.rotate(s.angle),t.shadowBlur=0,t.shadowColor="transparent",t.beginPath(),"handle"===s.type?(t.fillStyle=CONFIG.COLORS.SWORD_HANDLE,t.fillRect(-3*e,0,6*e,14*e),t.fillStyle=CONFIG.COLORS.SWORD_BLADE[2],t.moveTo(-i/2,0),t.lineTo(i/2,0),t.lineTo(i/2,.3*-a),t.lineTo(0,.2*-a),t.lineTo(-i/2,.35*-a),t.fill()):"mid"===s.type?(t.fillStyle=CONFIG.COLORS.SWORD_BLADE[1],t.moveTo(-i/2,0),t.lineTo(i/2,0),t.lineTo(i/2,.3*-a),t.lineTo(-i/2,.25*-a),t.fill()):"tip"===s.type&&(t.fillStyle=CONFIG.COLORS.SWORD_BLADE[0],t.moveTo(-i/2,0),t.lineTo(i/2,0),t.lineTo(0,.4*-a),t.fill()),t.restore()})}drawAura(t,e){const a=Math.floor(random(2,4));t.shadowColor=CONFIG.COLORS.SWORD_AURA_SHADOW,t.shadowBlur=8*e;for(let i=0;i<a;i++){t.beginPath();let a=-random(0,CONFIG.SWORD.SIZE*e),i=random(-3,3)*e;t.moveTo(i,a);for(let s=0;s<3;s++)i+=random(-4,4)*e,a+=random(-3,3)*e,t.lineTo(i,a);t.strokeStyle=`rgba(255,255,180,${random(.3,.6)})`,t.lineWidth=1.5*e,t.stroke()}}drawBlade(t,e){const a=CONFIG.SWORD.SIZE*e,i=4*e;t.shadowColor=CONFIG.COLORS.SWORD_GLOW_OUTER,t.shadowBlur=15*e;const s=t.createLinearGradient(0,-a,0,0);s.addColorStop(0,CONFIG.COLORS.SWORD_BLADE[0]),s.addColorStop(.5,CONFIG.COLORS.SWORD_BLADE[1]),s.addColorStop(1,CONFIG.COLORS.SWORD_BLADE[2]),t.fillStyle=s,t.beginPath(),t.moveTo(-i/2,0),t.lineTo(-i/2,-a),t.quadraticCurveTo(0,-a-10*e,i/2,-a),t.lineTo(i/2,0),t.fill(),t.shadowColor=CONFIG.COLORS.SWORD_GLOW_INNER,t.fillStyle=CONFIG.COLORS.SWORD_FRAGMENT,t.beginPath(),t.roundRect(-7*e,-1.2*e,14*e,2.4*e,2.4*e),t.fill(),t.fillStyle=CONFIG.COLORS.SWORD_HANDLE,t.beginPath(),t.moveTo(-3*e,0),t.lineTo(-2*e,14*e),t.lineTo(2*e,14*e),t.lineTo(3*e,0),t.fill()}}class StarField{constructor(t,e,a){this.stars=[];const i=CONFIG.BG.STAR_COUNT||t;for(let t=0;t<i;t++)this.stars.push({x:random(-e,2*e),y:random(-a,2*a),r:random(CONFIG.BG.STAR_SIZE.MIN,CONFIG.BG.STAR_SIZE.MAX),alpha:random(CONFIG.BG.STAR_ALPHA.MIN,CONFIG.BG.STAR_ALPHA.MAX)})}draw(t,e){t.shadowBlur=0;const a=CONFIG.BG.STAR_TWINKLE_SPEED;for(const i of this.stars)i.alpha+=random(-a,a),i.alpha>CONFIG.BG.STAR_ALPHA.MAX?i.alpha=CONFIG.BG.STAR_ALPHA.MAX:i.alpha<CONFIG.BG.STAR_ALPHA.MIN&&(i.alpha=CONFIG.BG.STAR_ALPHA.MIN),t.beginPath(),t.arc(i.x,i.y,i.r*e,0,2*Math.PI),t.fillStyle=`rgba(255,255,255,${i.alpha})`,t.fill()}}class Pill{constructor(t,e,a="LOW"){this.x=t,this.y=e,this.typeKey=a;const i=CONFIG.PILL.TYPES[a];this.r=i.radius,this.color=i.color,this.state=0,this.velocity={x:12*(Math.random()-.5),y:12*(Math.random()-.5)},this.friction=.96,this.spawnTime=Date.now(),this.history=[],this.maxHistory=CONFIG.PILL.TRAIL_LENGTH}update(t,e){const a=CONFIG.PILL;if(this.history.push({x:this.x,y:this.y}),this.history.length>this.maxHistory&&this.history.shift(),0===this.state)this.x+=this.velocity.x,this.y+=this.velocity.y,this.velocity.x*=this.friction,this.velocity.y*=this.friction,Date.now()-this.spawnTime>a.COLLECT_DELAY_MS&&(this.state=1);else{const i=t-this.x,s=e-this.y,n=Math.sqrt(i*i+s*s);if(this.x+=i/n*a.MAGNET_SPEED,this.y+=s/n*a.MAGNET_SPEED,n<20)return!0}return!1}draw(t){if(t.save(),this.history.length>1){t.beginPath(),t.moveTo(this.history[0].x,this.history[0].y);for(let e=1;e<this.history.length;e++)t.lineTo(this.history[e].x,this.history[e].y);t.strokeStyle=this.color,t.lineWidth=.8*this.r,t.lineCap="round",t.globalAlpha=.3,t.stroke()}t.shadowBlur=20,t.shadowColor=this.color,t.beginPath(),t.arc(this.x,this.y,this.r,0,2*Math.PI);const e=t.createRadialGradient(this.x,this.y,0,this.x,this.y,this.r);e.addColorStop(0,"#fff"),e.addColorStop(1,this.color),t.fillStyle=e,t.fill(),t.restore()}}const canvas=document.getElementById("c"),enemyIcons={},ctx=canvas.getContext("2d",{alpha:!1});let width,height,scaleFactor=1,frameCount=0,lastTime=performance.now(),visualParticles=[];function preloadEnemyIcons(){return Promise.all(CONFIG.ENEMY.ANIMALS.map(t=>new Promise(e=>{const a=new Image;a.src=t;const i=t.split("/").pop().split(".")[0];a.onload=()=>{enemyIcons[i]=a,e()},a.onerror=()=>{console.error("Failed to load icon:",t),e()}})))}function showNotify(t,e){let a=document.getElementById("game-notification");a||(a=document.createElement("div"),a.id="game-notification",document.body.appendChild(a)),a.children.length>2&&a.removeChild(a.firstChild);const i=document.createElement("div");i.className="notify-item",i.innerText=t,i.style.color=e,i.style.borderLeft=`3px solid ${e}`,a.appendChild(i),setTimeout(()=>{i.remove()},2500)}const Camera={currentZoom:1,targetZoom:1,update(){this.currentZoom+=(this.targetZoom-this.currentZoom)*CONFIG.ZOOM.SMOOTH},adjustZoom(t){this.targetZoom=Math.max(CONFIG.ZOOM.MIN,Math.min(CONFIG.ZOOM.MAX,this.targetZoom+t))},screenToWorld(t,e){const a=width/2,i=height/2;return{x:(t-a)/this.currentZoom+a,y:(e-i)/this.currentZoom+i}}};function resize(){width=canvas.width=window.innerWidth,height=canvas.height=window.innerHeight,scaleFactor=width/CONFIG.CORE.BASE_WIDTH}window.addEventListener("resize",resize),resize();const Input={screenX:width/2,screenY:height/2,x:width/2,y:height/2,px:0,py:0,speed:0,isAttacking:!1,guardForm:1,attackTimer:null,isTouchDevice:"ontouchstart"in window||navigator.maxTouchPoints>0,mana:CONFIG.MANA.START||100,maxMana:CONFIG.MANA.MAX||100,lastManaRegenTick:performance.now(),initialPinchDist:0,lastFrameTime:performance.now(),exp:0,rankIndex:0,pills:{LOW:0,MEDIUM:0,HIGH:0},isReadyToBreak:!1,calculateTotalPillBoost(){const t=CONFIG.PILL.TYPES;return this.pills.LOW*t.LOW.boost+this.pills.MEDIUM*t.MEDIUM.boost+this.pills.HIGH*t.HIGH.boost},processActiveConsumption(t){let e=0;this.speed>1&&(e+=CONFIG.MANA.COST_MOVE_PER_SEC*t),this.isAttacking&&(e+=CONFIG.MANA.COST_ATTACK_PER_SEC*t),e>0&&(this.mana>0?this.updateMana(-e):this.isAttacking&&(this.isAttacking=!1,this.triggerManaShake()))},updateMana(t){this.mana=Math.max(0,Math.min(this.maxMana,this.mana+t)),this.renderManaUI()},regenMana(){const t=performance.now(),e=t-this.lastManaRegenTick;if(e>=CONFIG.MANA.REGEN_INTERVAL_MS){const a=Math.floor(e/CONFIG.MANA.REGEN_INTERVAL_MS);a>0&&(this.updateMana(a*CONFIG.MANA.REGEN_PER_SEC),this.lastManaRegenTick=t-e%CONFIG.MANA.REGEN_INTERVAL_MS)}},renderManaUI(){const t=document.getElementById("mana-bar"),e=document.getElementById("mana-text");if(t&&e){const a=this.mana/this.maxMana*100;t.style.width=a+"%",e.innerText=`Linh lực: ${Math.round(this.mana)}/${this.maxMana}`,a<20?t.classList.add("low-mana"):t.classList.remove("low-mana")}},triggerManaShake(){const t=document.getElementById("mana-container");t.classList.remove("mana-shake","mana-empty-error"),t.offsetWidth,t.classList.add("mana-shake","mana-empty-error"),setTimeout(()=>{t.classList.remove("mana-shake","mana-empty-error")},500)},updateExp(t){const e=CONFIG.CULTIVATION.RANKS[this.rankIndex];if(!e)return;const a=e.exp*(CONFIG.CULTIVATION.OVERFLOW_LIMIT||1.2);this.isReadyToBreak?this.exp<a&&(this.exp+=.2*t,this.exp>=a&&(this.exp=a,this.forcedBreaking||(this.forcedBreaking=!0,showNotify("Linh lực quá tải, thiên đạo cưỡng ép đột phá!","#ff4444"),setTimeout(()=>{this.executeBreakthrough(!0),this.forcedBreaking=!1},1e3)))):(this.exp+=t,this.exp>=e.exp&&(this.exp=e.exp,this.isReadyToBreak=!0,showNotify("Linh khí tràn đầy, sẵn sàng đột phá!","#00ffcc"))),this.renderExpUI()},checkLevelUp(){const t=CONFIG.CULTIVATION.RANKS[this.rankIndex];t&&this.exp>=t.exp&&!this.isReadyToBreak&&(this.isReadyToBreak=!0,showNotify("Linh khí tràn đầy, sẵn sàng đột phá!","#00ffcc"))},executeBreakthrough(t=!1){const e=CONFIG.CULTIVATION.RANKS[this.rankIndex];if(!e)return;const a=this.calculateTotalPillBoost();let i=e.chance+a;const s=CONFIG.CULTIVATION.MAX_BREAKTHROUGH_CHANCE||.95;if(i=Math.min(s,i),Math.random()<=i){this.exp=0,this.rankIndex++,this.isReadyToBreak=!1,this.pills={LOW:0,MEDIUM:0,HIGH:0};const a=CONFIG.CULTIVATION.RANKS[this.rankIndex];a&&(a.maxMana&&(this.maxMana=a.maxMana),t?showNotify(`CƯỠNG ÉP ĐỘT PHÁ THÀNH CÔNG: ${a.name.toUpperCase()}`,"#ff8800"):(this.mana=this.maxMana,showNotify(`ĐỘT PHÁ THÀNH CÔNG: ${a.name.toUpperCase()}`,"#ffcc00"))),this.createLevelUpExplosion(this.x,this.y,e.color)}else{const t=CONFIG.CULTIVATION.BREAKTHROUGH_PENALTY_FACTOR,e=Math.floor(this.exp*t);this.exp-=e,this.isReadyToBreak=!1;const a=Math.round(100*t);this.pills.LOW=Math.floor(this.pills.LOW/2),this.pills.MEDIUM=Math.floor(this.pills.MEDIUM/2),this.pills.HIGH=Math.floor(this.pills.HIGH/2),showNotify(`ĐỘT PHÁ THẤT BẠI! Tâm ma phản phệ (-${a}% tu vi)`,"#ff4444"),this.triggerExpError()}this.renderExpUI(),this.renderManaUI()},renderExpUI(){const t=CONFIG.CULTIVATION.RANKS[this.rankIndex];if(!t)return;t.maxMana&&(this.maxMana=t.maxMana);const e=document.getElementById("exp-bar"),a=document.getElementById("exp-text"),i=document.getElementById("cultivation-rank"),s=document.querySelector(".breakthrough-group"),n=this.calculateTotalPillBoost(),o=CONFIG.CULTIVATION.MAX_BREAKTHROUGH_CHANCE||.99,h=(100*Math.min(o,t.chance+n)).toFixed(0),r=this.pills.LOW+this.pills.MEDIUM+this.pills.HIGH;if(a){let e=this.isReadyToBreak?'<span style="color:#ffcc00; font-weight:bold;">SẴN SÀNG ĐỘT PHÁ</span>':`Tu vi: ${Math.floor(this.exp)}/${t.exp}`;a.innerHTML=`${e} | <span style="color:#00ffcc">Linh Đan: ${r}</span> (<span style="color:#ffcc00">TL: ${h}%</span>)`}s&&(this.isReadyToBreak?s.classList.add("is-active"):s.classList.remove("is-active"));const l=this.exp/t.exp*100;e&&(e.style.width=Math.min(100,l)+"%",e.style.background=`linear-gradient(90deg, ${t.lightColor}, ${t.color})`,this.isReadyToBreak?(e.style.boxShadow=`0 0 15px #fff, 0 0 5px ${t.color}`,e.classList.add("exp-full-glow")):(e.style.boxShadow=`0 0 10px ${t.lightColor}`,e.classList.remove("exp-full-glow"))),i&&(i.innerText=`Cảnh giới: ${t.name}`,i.style.color=t.color)},triggerExpError(){const t=document.getElementById("exp-container");t.classList.add("shake-red"),setTimeout(()=>t.classList.remove("shake-red"),500)},update(t){const e=Camera.screenToWorld(this.screenX,this.screenY);this.x=e.x,this.y=e.y,this.speed=Math.hypot(this.x-this.px,this.y-this.py),this.px=this.x,this.py=this.y,this.processActiveConsumption(t)},handleMove(t){if(t.target.closest(".btn"))return;const e=t.touches?t.touches[0]:t;this.screenX=e.clientX,this.screenY=e.clientY},handleDown(t){t.target.closest(".btn")||this.isTouchDevice||(t.preventDefault(),this.attackTimer=setTimeout(()=>{this.isAttacking=!0},CONFIG.SWORD.ATTACK_DELAY_MS))},handleUp(t){this.isTouchDevice||(this.isAttacking=!1,clearTimeout(this.attackTimer))},handleWheel(t){const e=-t.deltaY*CONFIG.ZOOM.SENSITIVITY;Camera.adjustZoom(e)},createLevelUpExplosion(t,e,a){for(let i=0;i<30;i++)visualParticles.push({x:t,y:e,vx:8*(Math.random()-.5),vy:8*(Math.random()-.5),size:3*Math.random()+1,life:1,color:a||"#fff"})}};window.addEventListener("pointermove",t=>{t.touches||Input.handleMove(t)}),window.addEventListener("pointerdown",t=>Input.handleDown(t)),window.addEventListener("pointerup",t=>Input.handleUp(t)),window.addEventListener("wheel",t=>{Camera.adjustZoom(-t.deltaY*CONFIG.ZOOM.SENSITIVITY)},{passive:!1}),window.addEventListener("keydown",t=>{"+"!==t.key&&"="!==t.key||Camera.adjustZoom(CONFIG.ZOOM.STEP),"-"!==t.key&&"_"!==t.key||Camera.adjustZoom(-CONFIG.ZOOM.STEP)}),window.addEventListener("touchstart",t=>{2===t.touches.length&&(Input.initialPinchDist=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY))},{passive:!1}),window.addEventListener("touchmove",t=>{if(2===t.touches.length){t.preventDefault();const e=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY),a=.01*(e-Input.initialPinchDist);Camera.adjustZoom(a),Input.initialPinchDist=e}else Input.handleMove(t)},{passive:!1});const SettingsUI={overlay:document.getElementById("settings-popup"),btnOpen:document.getElementById("btn-settings"),btnClose:document.getElementById("close-settings"),btnSave:document.getElementById("save-settings"),init(){if(!this.overlay||!this.btnOpen)return;this.load(),this.btnOpen.addEventListener("pointerdown",t=>{t.stopPropagation(),this.open()});const t=this.overlay.querySelector(".popup-content");t&&t.addEventListener("pointerdown",t=>{t.stopPropagation()}),this.btnClose&&this.btnClose.addEventListener("pointerdown",t=>{t.stopPropagation(),this.close()}),this.btnSave&&this.btnSave.addEventListener("pointerdown",t=>{t.stopPropagation(),this.save()}),this.overlay.addEventListener("pointerdown",t=>{t.target===this.overlay&&(t.stopPropagation(),this.close())})},load(){const t=localStorage.getItem("thanh_truc_settings");if(t)try{const e=JSON.parse(t);e.BG&&Object.assign(CONFIG.BG,e.BG),e.ZOOM&&Object.assign(CONFIG.ZOOM,e.ZOOM),e.COLORS&&Object.assign(CONFIG.COLORS,e.COLORS),e.SWORD&&Object.assign(CONFIG.SWORD,e.SWORD),e.ENEMY&&Object.assign(CONFIG.ENEMY,e.ENEMY),e.MANA&&Object.assign(CONFIG.MANA,e.MANA),e.PILL&&Object.assign(CONFIG.PILL,e.PILL),e.CULTIVATION&&Object.assign(CONFIG.CULTIVATION,e.CULTIVATION),console.log("Thiên Thư đã được phục hồi từ LocalStorage.")}catch(t){console.error("Lỗi đọc Thiên Thư:",t)}},close(){this.overlay.classList.remove("show"),setTimeout(()=>{this.overlay.classList.contains("show")||(this.overlay.style.display="none")},300),document.body.style.cursor="none"},open(){document.body.style.cursor="default";const t={"cfg-bg-star-count":CONFIG.BG.STAR_COUNT,"cfg-bg-star-min":CONFIG.BG.STAR_SIZE.MIN,"cfg-bg-star-twinkle":CONFIG.BG.STAR_TWINKLE_SPEED,"cfg-zoom-smooth":CONFIG.ZOOM.SMOOTH,"cfg-zoom-sens":CONFIG.ZOOM.SENSITIVITY,"cfg-col-bg-fade":CONFIG.COLORS.BG_FADE,"cfg-sw-count":CONFIG.SWORD.COUNT,"cfg-sw-radius":CONFIG.SWORD.BASE_RADIUS,"cfg-sw-spacing":CONFIG.SWORD.LAYER_SPACING,"cfg-sw-spin":CONFIG.SWORD.SPIN_SPEED_BASE,"cfg-sw-speed-mult":CONFIG.SWORD.SPEED_MULT,"cfg-sw-trail":CONFIG.SWORD.TRAIL_LENGTH,"cfg-sw-size":CONFIG.SWORD.SIZE,"cfg-sw-respawn":CONFIG.SWORD.RESPAWN_DELAY_MS,"cfg-sw-death-wait":CONFIG.SWORD.DEATH_WAIT_MS,"cfg-sw-breath":CONFIG.SWORD.BREATH_SPEED.MIN,"cfg-sw-stun":CONFIG.SWORD.STUN_DURATION_MS,"cfg-sw-regen":CONFIG.SWORD.REGEN_INTERVAL_MS,"cfg-en-spawn":CONFIG.ENEMY.SPAWN_COUNT,"cfg-en-elite":CONFIG.ENEMY.ELITE_CHANCE,"cfg-en-shield-ch":CONFIG.ENEMY.SHIELD_CHANCE,"cfg-en-shield-hp":CONFIG.ENEMY.SHIELD_HP_RATIO,"cfg-en-debris":CONFIG.ENEMY.DEBRIS.COUNT,"cfg-ma-regen":CONFIG.MANA.REGEN_PER_SEC,"cfg-ma-atk":CONFIG.MANA.COST_ATTACK_PER_SEC,"cfg-ma-move":CONFIG.MANA.COST_MOVE_PER_SEC,"cfg-ma-res-cost":Math.abs(CONFIG.MANA.COST_RESPAWN),"cfg-sw-change-form":CONFIG.MANA.COST_CHANGE_FORM,"cfg-sw-gain-kill":CONFIG.MANA.GAIN_KILL,"cfg-pi-chance":CONFIG.PILL.CHANCE,"cfg-pi-magnet":CONFIG.PILL.MAGNET_SPEED,"cfg-pi-trail":CONFIG.PILL.TRAIL_LENGTH,"cfg-cu-penalty":CONFIG.CULTIVATION.BREAKTHROUGH_PENALTY_FACTOR,"cfg-cu-max-chance":CONFIG.CULTIVATION.MAX_BREAKTHROUGH_CHANCE};for(let e in t){let a=document.getElementById(e);if(a){const i=t[e];a.value=void 0!==i?i:""}}this.overlay.style.display="flex",setTimeout(()=>this.overlay.classList.add("show"),10)},save(){try{CONFIG.BG.STAR_COUNT=parseInt(document.getElementById("cfg-bg-star-count").value),CONFIG.BG.STAR_SIZE.MIN=parseFloat(document.getElementById("cfg-bg-star-min").value),CONFIG.BG.STAR_TWINKLE_SPEED=parseFloat(document.getElementById("cfg-bg-star-twinkle").value),CONFIG.ZOOM.SMOOTH=parseFloat(document.getElementById("cfg-zoom-smooth").value),CONFIG.ZOOM.SENSITIVITY=parseFloat(document.getElementById("cfg-zoom-sens").value),CONFIG.COLORS.BG_FADE=document.getElementById("cfg-col-bg-fade").value,CONFIG.SWORD.COUNT=parseInt(document.getElementById("cfg-sw-count").value),CONFIG.SWORD.BASE_RADIUS=parseInt(document.getElementById("cfg-sw-radius").value),CONFIG.SWORD.LAYER_SPACING=parseInt(document.getElementById("cfg-sw-spacing").value),CONFIG.SWORD.SPIN_SPEED_BASE=parseFloat(document.getElementById("cfg-sw-spin").value),CONFIG.SWORD.SPEED_MULT=parseFloat(document.getElementById("cfg-sw-speed-mult").value),CONFIG.SWORD.TRAIL_LENGTH=parseInt(document.getElementById("cfg-sw-trail").value),CONFIG.SWORD.SIZE=parseInt(document.getElementById("cfg-sw-size").value),CONFIG.SWORD.RESPAWN_DELAY_MS=parseInt(document.getElementById("cfg-sw-respawn").value),CONFIG.SWORD.DEATH_WAIT_MS=parseInt(document.getElementById("cfg-sw-death-wait").value),CONFIG.SWORD.STUN_DURATION_MS=parseInt(document.getElementById("cfg-sw-stun").value),CONFIG.SWORD.REGEN_INTERVAL_MS=parseInt(document.getElementById("cfg-sw-regen").value),CONFIG.ENEMY.SPAWN_COUNT=parseInt(document.getElementById("cfg-en-spawn").value),CONFIG.ENEMY.ELITE_CHANCE=parseFloat(document.getElementById("cfg-en-elite").value),CONFIG.ENEMY.SHIELD_CHANCE=parseFloat(document.getElementById("cfg-en-shield-ch").value),CONFIG.ENEMY.SHIELD_HP_RATIO=parseFloat(document.getElementById("cfg-en-shield-hp").value),CONFIG.ENEMY.DEBRIS.COUNT=parseInt(document.getElementById("cfg-en-debris").value),CONFIG.MANA.REGEN_PER_SEC=parseFloat(document.getElementById("cfg-ma-regen").value),CONFIG.MANA.COST_ATTACK_PER_SEC=parseFloat(document.getElementById("cfg-ma-atk").value),CONFIG.MANA.COST_MOVE_PER_SEC=parseFloat(document.getElementById("cfg-ma-move").value),CONFIG.MANA.COST_RESPAWN=-Math.abs(parseFloat(document.getElementById("cfg-ma-res-cost").value)),CONFIG.MANA.COST_CHANGE_FORM=parseFloat(document.getElementById("cfg-sw-change-form").value),CONFIG.MANA.GAIN_KILL=parseFloat(document.getElementById("cfg-sw-gain-kill").value),CONFIG.PILL.CHANCE=parseFloat(document.getElementById("cfg-pi-chance").value),CONFIG.PILL.MAGNET_SPEED=parseInt(document.getElementById("cfg-pi-magnet").value),CONFIG.PILL.TRAIL_LENGTH=parseInt(document.getElementById("cfg-pi-trail").value),CONFIG.CULTIVATION.BREAKTHROUGH_PENALTY_FACTOR=parseFloat(document.getElementById("cfg-cu-penalty").value),CONFIG.CULTIVATION.MAX_BREAKTHROUGH_CHANCE=parseFloat(document.getElementById("cfg-cu-max-chance").value),localStorage.setItem("thanh_truc_settings",JSON.stringify(CONFIG)),swords.length=0,enemies.length=0,visualParticles.length=0;for(let t=0;t<CONFIG.SWORD.COUNT;t++)swords.push(new Sword(t,scaleFactor));for(let t=0;t<CONFIG.ENEMY.SPAWN_COUNT;t++)enemies.push(new Enemy);starField=new StarField(CONFIG.BG.STAR_COUNT,width,height),showNotify("Trận pháp đã được tái thiết!","#8fffe0"),this.close()}catch(t){console.error("Lỗi khi ghi chép Thiên Thư:",t)}}};document.getElementById("btn-form").addEventListener("pointerdown",t=>{t.stopPropagation(),t.preventDefault();const e=CONFIG.MANA.COST_CHANGE_FORM;if(Input.mana>=e){Input.updateMana(-e),Input.guardForm=1===Input.guardForm?2:1;const a=t.currentTarget.querySelector(".icon-form");a&&(a.style.transform=`rotate(${1===Input.guardForm?-15:165}deg)`)}else Input.triggerManaShake()}),document.getElementById("btn-breakthrough").addEventListener("pointerdown",t=>{t.stopPropagation(),Input.executeBreakthrough()});const attackBtn=document.getElementById("btn-attack"),startAttack=t=>{t.stopPropagation(),t.preventDefault();const e=swords.filter(t=>!t.isDead).length;if(Input.mana<=0&&0===e)return Input.triggerManaShake(),void(Input.isAttacking=!1);Input.isAttacking=!0},stopAttack=t=>{t.stopPropagation(),t.preventDefault(),Input.isAttacking=!1,Input.attackTimer&&clearTimeout(Input.attackTimer)};attackBtn.addEventListener("pointerdown",startAttack),attackBtn.addEventListener("pointerup",stopAttack),attackBtn.addEventListener("pointerleave",stopAttack);const enemies=[];let pills=[];const swords=[];let starField;const guardCenter={x:width/2,y:height/2,vx:0,vy:0};function init(){const t=CONFIG.CULTIVATION.RANKS[Input.rankIndex];Input.maxMana=t.maxMana||CONFIG.MANA.MAX,Input.mana=Input.maxMana,Input.renderManaUI(),Input.renderExpUI(),SettingsUI.init(),starField=new StarField(250,width,height);for(let t=0;t<CONFIG.ENEMY.SPAWN_COUNT;t++)enemies.push(new Enemy);for(let t=0;t<CONFIG.SWORD.COUNT;t++)swords.push(new Sword(t,scaleFactor))}function updateSwordCounter(t){const e=t.filter(t=>!t.isDead).length,a=t.length,i=document.getElementById("sword-count-text");i&&(i.innerText=`${e}/${a}`,i.style.color=e<.3*a?"#ff4444":"#fff")}function updatePhysics(t){Camera.update(),Input.update(t),Input.regenMana();let e=Input.x-guardCenter.x,a=Input.y-guardCenter.y;guardCenter.vx+=.04*e,guardCenter.vy+=.04*a,guardCenter.vx*=.82,guardCenter.vy*=.82,guardCenter.x+=guardCenter.vx,guardCenter.y+=guardCenter.vy}function renderCursor(){ctx.shadowBlur=10,ctx.shadowColor="#6fffe0",ctx.beginPath(),ctx.arc(Input.x,Input.y,4*scaleFactor,0,2*Math.PI),ctx.fillStyle="#6fffe0",ctx.fill(),ctx.shadowBlur=0}function animate(){const t=performance.now(),e=(t-lastTime)/1e3;lastTime=t,frameCount++,ctx.fillStyle=CONFIG.COLORS.BG_FADE,ctx.fillRect(0,0,width,height),updatePhysics(e),frameCount%10==0&&updateSwordCounter(swords),ctx.save(),ctx.translate(width/2,height/2),ctx.scale(Camera.currentZoom,Camera.currentZoom),ctx.translate(-width/2,-height/2),starField.draw(ctx,scaleFactor),ctx.save(),ctx.translate(guardCenter.x,guardCenter.y),ctx.rotate(2e-4*performance.now()),ctx.strokeStyle="rgba(120,255,210,0.1)",ctx.lineWidth=1.5*scaleFactor,ctx.beginPath(),ctx.arc(0,0,50*scaleFactor,0,2*Math.PI),ctx.stroke(),ctx.restore(),enemies.forEach(t=>t.draw(ctx,scaleFactor)),pills=pills.filter(t=>{if(t.update(window.innerWidth/2,window.innerHeight/2)){Input.pills[t.typeKey]++;return showNotify(`+1 ${CONFIG.PILL.TYPES[t.typeKey].name}`,t.color),Input.renderExpUI(),!1}return t.draw(ctx),!0}),swords.forEach(t=>{t.update(guardCenter,enemies,Input,scaleFactor),t.draw(ctx,scaleFactor)}),renderCursor(),visualParticles.forEach((t,e)=>{t.x+=t.vx,t.y+=t.vy,t.life-=.02,ctx.globalAlpha=t.life,ctx.fillStyle=t.color,ctx.beginPath(),ctx.arc(t.x,t.y,t.size,0,2*Math.PI),ctx.fill(),t.life<=0&&visualParticles.splice(e,1)}),ctx.globalAlpha=1,ctx.restore(),requestAnimationFrame(animate)}!async function(){await preloadEnemyIcons(),init(),animate()}();