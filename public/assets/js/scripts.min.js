const CONFIG={CORE:{BASE_WIDTH:1920},ZOOM:{MIN:.5,MAX:5,SENSITIVITY:.001,STEP:.2,SMOOTH:.1},BG:{STAR_COUNT:1e3,STAR_SIZE:{MIN:.5,MAX:2},STAR_ALPHA:{MIN:.2,MAX:1},STAR_TWINKLE_SPEED:.01},SWORD:{COUNT:72,BASE_RADIUS:130,LAYER_SPACING:70,SPIN_SPEED_BASE:.07,ATTACK_DELAY_MS:180,TRAIL_LENGTH:6,SIZE:70,STUN_DURATION_MS:1e3,DURABILITY:10,RESPAWN_DELAY_MS:1e3,DEATH_WAIT_MS:2e3,SPEED_MULT:100,BREATH_SPEED:{MIN:.015,MAX:.025},FLOW_OFFSET:{MIN:40,MAX:100},ATTACK_DELAY_VAR:{BASE:6,RAND:10},FRAGMENTS:{LIFE_TIME:1500,FADE_TIME:500}},INPUT:{DOUBLE_TAP_DELAY:300},COLORS:{BG_FADE:"rgba(0, 0, 8, 0.25)",SWORD_BLADE:["#d0fff5","#7fdcc0","#3fa78a"],SWORD_TRAIL:"rgba(120, 255, 210, 0.3)",SWORD_HANDLE:"#2f7f68",SWORD_GLOW_OUTER:"#8fffe0",SWORD_GLOW_INNER:"#9fffe6",SWORD_FRAGMENT:"#2a5a4d",SWORD_AURA_SHADOW:"#fffaa0",ENEMY_PARTICLE:"#8cf0ff",ENEMY_SHADOW_SHIELD:"#00ffff",SHIELD_GLOW:"rgba(0, 255, 255, 0.8)",SHIELD_RING_PULSE:"rgba(140, 245, 255, 1)",SHIELD_RING_OUTER:"rgba(140, 245, 255, 0.2)"},ENEMY:{SPAWN_COUNT:6,SPAWN_PADDING:50,BASE_SIZE:{MIN:10,VAR:50},HP:{BASE:1,VAR:100},SHIELD_CHANCE:.3,SHIELD_MAX_HP:80,SHIELD_COLOR:"rgba(100, 200, 255, 0.4)",SHIELD_LINE:"#80dfff",DEBRIS:{COUNT:50,SPEED:{MIN:4,MAX:12},SIZE:{MIN:2,MAX:5},LIFE_DECAY:.025},PALETTES:[["#ff9999","#cc3333"],["#99ccff","#3366cc"],["#99ff99","#33cc33"],["#ffcc99","#cc6600"],["#ff99ff","#cc33cc"],["#ffff99","#cccc33"]]},MANA:{MAX:100,START:100,REGEN_PER_MIN:1,REGEN_INTERVAL_MS:3e3,COST_RESPAWN:-1,GAIN_KILL:1,COST_MOVE_PER_SEC:1,COST_ATTACK_PER_SEC:1,COST_CHANGE_FORM:1},CULTIVATION:{RANKS:[{name:"Luyện Khí sơ kỳ (Tầng 1)",exp:5,chance:1,damage:1,color:"#4CAF50",lightColor:"#A5D6A7"},{name:"Luyện Khí sơ kỳ (Tầng 2)",exp:6,chance:.95,damage:1,color:"#4CAF50",lightColor:"#A5D6A7"},{name:"Luyện Khí sơ kỳ (Tầng 3)",exp:7,chance:.95,damage:1,color:"#4CAF50",lightColor:"#A5D6A7"},{name:"Luyện Khí sơ kỳ (Tầng 4)",exp:9,chance:.95,damage:1,color:"#4CAF50",lightColor:"#A5D6A7"},{name:"Luyện Khí trung kỳ (Tầng 5)",exp:12,chance:.9,damage:1,color:"#43A047",lightColor:"#C8E6C9"},{name:"Luyện Khí trung kỳ (Tầng 6)",exp:16,chance:.9,damage:1,color:"#43A047",lightColor:"#C8E6C9"},{name:"Luyện Khí trung kỳ (Tầng 7)",exp:21,chance:.9,damage:1,color:"#43A047",lightColor:"#C8E6C9"},{name:"Luyện Khí trung kỳ (Tầng 8)",exp:27,chance:.9,damage:1,color:"#43A047",lightColor:"#C8E6C9"},{name:"Luyện Khí hậu kỳ (Tầng 9)",exp:35,chance:.85,damage:1,color:"#2E7D32",lightColor:"#E8F5E9"},{name:"Luyện Khí hậu kỳ (Tầng 10)",exp:45,chance:.85,damage:1,color:"#2E7D32",lightColor:"#E8F5E9"},{name:"Luyện Khí hậu kỳ (Tầng 11)",exp:58,chance:.85,damage:1,color:"#2E7D32",lightColor:"#E8F5E9"},{name:"Luyện Khí hậu kỳ (Tầng 12)",exp:75,chance:.8,damage:1,color:"#2E7D32",lightColor:"#E8F5E9"},{name:"Luyện Khí đại viên mãn (Tầng 13)",exp:100,chance:.75,damage:1,bonus:100,color:"#1B5E20",lightColor:"#FFFFFF"},{name:"Trúc Cơ sơ kỳ",exp:120,chance:.7,damage:2,color:"#2196F3",lightColor:"#90CAF9"},{name:"Trúc Cơ trung kỳ",exp:180,chance:.65,damage:2,color:"#1E88E5",lightColor:"#BBDEFB"},{name:"Trúc Cơ hậu kỳ",exp:270,chance:.6,damage:2,color:"#1565C0",lightColor:"#E3F2FD"},{name:"Trúc Cơ đại viên mãn",exp:400,chance:.55,damage:2,bonus:300,color:"#0D47A1",lightColor:"#FFFFFF"},{name:"Kết Đan sơ kỳ",exp:600,chance:.5,damage:3,color:"#FF9800",lightColor:"#FFCC80"},{name:"Kết Đan trung kỳ",exp:900,chance:.45,damage:3,color:"#FB8C00",lightColor:"#FFE0B2"},{name:"Kết Đan hậu kỳ",exp:1400,chance:.4,damage:3,color:"#EF6C00",lightColor:"#FFF3E0"},{name:"Kết Đan đại viên mãn",exp:2e3,chance:.35,damage:3,bonus:1500,color:"#E65100",lightColor:"#FFFFFF"},{name:"Nguyên Anh sơ kỳ",exp:3e3,chance:.35,damage:4,color:"#E91E63",lightColor:"#F48FB1"},{name:"Nguyên Anh trung kỳ",exp:5e3,chance:.3,damage:4,color:"#D81B60",lightColor:"#F8BBD0"},{name:"Nguyên Anh hậu kỳ",exp:8e3,chance:.25,damage:4,color:"#C2185B",lightColor:"#FCE4EC"},{name:"Nguyên Anh đại viên mãn",exp:12e3,chance:.2,damage:4,bonus:8e3,color:"#880E4F",lightColor:"#FFFFFF"},{name:"Hóa Thần sơ kỳ",exp:18e3,chance:.2,damage:5,color:"#9C27B0",lightColor:"#CE93D8"},{name:"Hóa Thần trung kỳ",exp:25e3,chance:.18,damage:5,color:"#8E24AA",lightColor:"#E1BEE7"},{name:"Hóa Thần hậu kỳ",exp:35e3,chance:.15,damage:5,color:"#7B1FA2",lightColor:"#F3E5F5"},{name:"Hóa Thần đại viên mãn",exp:5e4,chance:.12,damage:5,bonus:25e3,color:"#4A148C",lightColor:"#FFFFFF"},{name:"Luyện Hư sơ kỳ",exp:6e4,chance:.12,damage:6,color:"#3F51B5",lightColor:"#9FA8DA"},{name:"Luyện Hư trung kỳ",exp:8e4,chance:.1,damage:6,color:"#3949AB",lightColor:"#C5CAE9"},{name:"Luyện Hư hậu kỳ",exp:11e4,chance:.09,damage:6,color:"#303F9F",lightColor:"#E8EAF6"},{name:"Luyện Hư đại viên mãn",exp:15e4,chance:.08,damage:6,bonus:3e4,color:"#1A237E",lightColor:"#FFFFFF"},{name:"Hợp Thể sơ kỳ",exp:14e4,chance:.08,damage:7,color:"#00BCD4",lightColor:"#80DEEA"},{name:"Hợp Thể trung kỳ",exp:18e4,chance:.07,damage:7,color:"#00ACC1",lightColor:"#B2EBF2"},{name:"Hợp Thể hậu kỳ",exp:23e4,chance:.06,damage:7,color:"#0097A7",lightColor:"#E0F7FA"},{name:"Hợp Thể đại viên mãn",exp:3e5,chance:.05,damage:7,bonus:5e4,color:"#006064",lightColor:"#FFFFFF"},{name:"Đại Thừa sơ kỳ",exp:3e5,chance:.05,damage:8,color:"#F44336",lightColor:"#EF9A9A"},{name:"Đại Thừa trung kỳ",exp:38e4,chance:.04,damage:8,color:"#E53935",lightColor:"#FFCDD2"},{name:"Đại Thừa hậu kỳ",exp:48e4,chance:.03,damage:8,color:"#D32F2F",lightColor:"#FFEBEE"},{name:"Đại Thừa đại viên mãn",exp:6e5,chance:.02,damage:8,bonus:8e4,color:"#B71C1C",lightColor:"#FFFFFF"},{name:"Chân Tiên sơ kỳ",exp:6e5,chance:.02,damage:9,color:"#FFD700",lightColor:"#FFF59D"},{name:"Chân Tiên trung kỳ",exp:75e4,chance:.015,damage:9,color:"#FFC107",lightColor:"#FFF9C4"},{name:"Chân Tiên hậu kỳ",exp:95e4,chance:.01,damage:9,color:"#FFA000",lightColor:"#FFFDE7"},{name:"Chân Tiên đại viên mãn",exp:999999999,chance:0,damage:10,color:"#FF8F00",lightColor:"#FFFFFF"}]}},random=(t,e)=>Math.random()*(e-t)+t;class Enemy{constructor(){this.particles=[],this.respawn()}respawn(){const t=Camera.currentZoom,e=window.innerWidth/t,a=window.innerHeight/t,n=window.innerWidth/2-e/2,i=window.innerHeight/2-a/2,o=CONFIG.ENEMY.SPAWN_PADDING;this.x=random(n+o,n+e-o),this.y=random(i+o,i+a-o),this.particles=[];const h=CONFIG.ENEMY.BASE_SIZE.MIN,s=CONFIG.ENEMY.BASE_SIZE.VAR;this.r=(h+Math.pow(Math.random(),1.5)*s)*(window.innerWidth/CONFIG.CORE.BASE_WIDTH),this.maxHp=CONFIG.ENEMY.HP.BASE+Math.floor(Math.random()*CONFIG.ENEMY.HP.VAR),this.hp=this.maxHp,this.hasShield=Math.random()<CONFIG.ENEMY.SHIELD_CHANCE,this.maxShieldHp=CONFIG.ENEMY.SHIELD_MAX_HP,this.shieldHp=this.hasShield?this.maxShieldHp:0,this.cracks=[],this.shieldLevel=0,this.colors=CONFIG.ENEMY.PALETTES[Math.floor(Math.random()*CONFIG.ENEMY.PALETTES.length)]}generateCracks(t){const e=this.r+10,a=Math.random()*Math.PI*2,n=5+2*t,i=[];for(let t=0;t<n;t++){const o=a+t*Math.PI*2/n,h=[],s=4;for(let t=0;t<=s;t++){const a=e*t/s,n=0===t?0:.2*(Math.random()-.5);h.push({x:Math.cos(o+n)*a,y:Math.sin(o+n)*a})}this.cracks.push(h),i.push(h)}const o=2+t;for(let t=1;t<=o;t++){const e=Math.floor((i[0].length-1)*(t/(o+1)));for(let t=0;t<i.length;t++){const a=(t+1)%i.length,n=i[t][e],o=i[a][e];Math.random()>.2&&this.cracks.push([n,o])}}}hit(t){const e=CONFIG.CULTIVATION.RANKS[Input.rankIndex],a=e?e.damage:1;if(this.hasShield&&this.shieldHp>0){this.shieldHp-=a;let t=Math.floor((this.maxShieldHp-this.shieldHp)/20);return t>this.shieldLevel&&(this.shieldLevel=t,this.generateCracks(this.shieldLevel)),this.shieldHp<=0&&(this.hasShield=!1,this.createShieldDebris()),"shielded"}if(this.hp-=a,this.hp<=0){this.respawn(),Input.updateMana(CONFIG.MANA.GAIN_KILL);const t=this.maxShieldHp>0?2:1;return Input.updateExp(t),"killed"}return"hit"}drawShield(t,e){const a=(this.r+10)*e,n=.15*Math.sin(.006*Date.now())+.85;t.save(),t.beginPath(),t.arc(0,0,a,0,2*Math.PI),t.clip();const i=t.createRadialGradient(0,0,0,0,0,a);i.addColorStop(0,"rgba(255, 255, 255, 0)"),i.addColorStop(.7,"rgba(100, 210, 255, 0.15)"),i.addColorStop(1,`rgba(150, 240, 255, ${.3*n})`),t.fillStyle=i,t.fill(),this.cracks.length>0&&(t.beginPath(),t.strokeStyle=`rgba(255, 255, 255, ${.6+.1*this.shieldLevel})`,t.lineWidth=(1.2+.4*this.shieldLevel)*e,t.lineCap="round",t.lineJoin="round",this.cracks.forEach(a=>{t.moveTo(a[0].x*e,a[0].y*e);for(let n=1;n<a.length;n++)t.lineTo(a[n].x*e,a[n].y*e)}),t.stroke(),this.shieldLevel>=2&&(t.globalAlpha=.4,t.shadowBlur=10*e,t.shadowColor="#ffffff",t.lineWidth=2.5*e,t.stroke())),t.restore(),t.save(),t.beginPath(),t.arc(0,0,a,0,2*Math.PI),t.shadowBlur=15*e,t.shadowColor=CONFIG.COLORS.SHIELD_GLOW,t.strokeStyle=`rgba(140, 245, 255, ${n})`,t.lineWidth=3.5*e,t.stroke(),t.beginPath(),t.arc(0,0,a+3*e,0,2*Math.PI),t.strokeStyle=CONFIG.COLORS.SHIELD_RING_OUTER,t.lineWidth=1*e,t.stroke(),t.restore()}createShieldDebris(){const t=CONFIG.ENEMY.DEBRIS;for(let e=0;e<t.COUNT;e++){const e=Math.random()*Math.PI*2,a=random(t.SPEED.MIN,t.SPEED.MAX);this.particles.push({x:0,y:0,vx:Math.cos(e)*a,vy:Math.sin(e)*a,size:random(t.SIZE.MIN,t.SIZE.MAX),life:1,rotation:Math.random()*Math.PI*2,spin:random(-.5,.5)})}}draw(t,e){t.save(),t.translate(this.x,this.y),this.drawParticles(t,e),this.hasShield&&this.drawShield(t,e),this.drawBody(t,e),t.restore()}drawParticles(t,e){const a=CONFIG.ENEMY.DEBRIS.LIFE_DECAY;for(let n=this.particles.length-1;n>=0;n--){let i=this.particles[n];if(i.x+=i.vx,i.y+=i.vy,i.life-=a,i.life<=0){this.particles.splice(n,1);continue}t.save(),t.translate(i.x*e,i.y*e),t.rotate(i.rotation+=i.spin),t.globalAlpha=i.life,t.fillStyle=CONFIG.COLORS.ENEMY_PARTICLE;const o=i.size*e;t.fillRect(-o/2,-o/2,o,o),t.restore()}}drawBody(t,e){t.globalAlpha=1;const a=t.createRadialGradient(0,0,.2*this.r,0,0,this.r);a.addColorStop(0,this.colors[0]),a.addColorStop(1,this.colors[1]),t.beginPath(),t.arc(0,0,this.r,0,2*Math.PI),t.fillStyle=a,this.hasShield?(t.shadowColor=CONFIG.COLORS.ENEMY_SHADOW_SHIELD,t.shadowBlur=30*e,t.strokeStyle="rgba(255, 255, 255, 0.8)",t.lineWidth=3*e,t.stroke()):(t.shadowColor=this.colors[1],t.shadowBlur=15*e),t.fill(),t.shadowBlur=0}}class Sword{constructor(t,e){this.index=t,this.layer=Math.floor(t/24),this.baseAngle=2*Math.PI/24*(t%24),this.spinAngle=0,this.spinSpeed=CONFIG.SWORD.SPIN_SPEED_BASE/(this.layer+1)*(this.layer%2?-1:1),this.radius=(CONFIG.SWORD.BASE_RADIUS+this.layer*CONFIG.SWORD.LAYER_SPACING)*e,this.x=window.innerWidth/2,this.y=window.innerHeight/2,this.vx=0,this.vy=0,this.drawAngle=0,this.trail=[],this.breath=random(0,2*Math.PI),this.breathSpeed=random(CONFIG.SWORD.BREATH_SPEED.MIN,CONFIG.SWORD.BREATH_SPEED.MAX),this.attackDelay=this.layer*CONFIG.SWORD.ATTACK_DELAY_VAR.BASE+random(0,CONFIG.SWORD.ATTACK_DELAY_VAR.RAND),this.attackFrame=0,this.flowNoise=Math.random()*Math.PI*2,this.flowOffsetAngle=2*Math.PI/72*t,this.flowOffsetRadius=(CONFIG.SWORD.FLOW_OFFSET.MIN+Math.random()*(CONFIG.SWORD.FLOW_OFFSET.MAX-CONFIG.SWORD.FLOW_OFFSET.MIN))*e,this.isStunned=!1,this.stunTimer=0,this.maxHp=CONFIG.SWORD.DURABILITY||3,this.hp=this.maxHp,this.isDead=!1,this.respawnTimer=0,this.fragments=[],this.deathTime=0}update(t,e,a,n){if(this.isDead){const t=performance.now();return void(t>this.respawnTimer&&(a.mana>=Math.abs(CONFIG.MANA.COST_RESPAWN)?(a.updateMana(CONFIG.MANA.COST_RESPAWN),this.respawn(a)):this.respawnTimer=t+1e3))}if(this.isStunned)return void this.handleStun(n);this.breath+=this.breathSpeed,this.breathSpeed=random(CONFIG.SWORD.BREATH_SPEED.MIN,CONFIG.SWORD.BREATH_SPEED.MAX);const i=this.radius+8*Math.sin(this.breath)*n;a.isAttacking?this.updateAttackMode(e,a,n):this.updateGuardMode(t,i,a,n)}handleStun(t){this.x+=this.vx,this.y+=this.vy,this.vx*=.95,this.vy*=.95,this.drawAngle+=.2,this.trail.push({x:this.x,y:this.y}),this.trail.length>CONFIG.SWORD.TRAIL_LENGTH&&this.trail.shift(),performance.now()>this.stunTimer&&(this.isStunned=!1,this.vx*=.2,this.vy*=.2)}respawn(t){this.isDead=!1,this.hp=this.maxHp,this.x=t.x,this.y=t.y,this.vx=0,this.vy=0,this.isStunned=!1,this.trail=[],this.fragments=[]}updateGuardMode(t,e,a,n){const i=performance.now()/1e3*this.spinSpeed*(CONFIG.SWORD.SPEED_MULT||100),o=this.baseAngle+i,h=t.x+Math.cos(o)*e,s=t.y+Math.sin(o)*e;if(a.speed>1.5){const t=h-this.x,e=s-this.y,a=Math.hypot(t,e)||1;this.vx+=t/a*Math.min(.05*a,4*n),this.vy+=e/a*Math.min(.05*a,4*n),this.vx*=.85,this.vy*=.85,this.x+=this.vx,this.y+=this.vy,this.drawAngle=Math.atan2(this.vy,this.vx)+Math.PI/2}else{const t=h-this.x,e=s-this.y;this.x+=.12*t,this.y+=.12*e,this.vx*=.5,this.vy*=.5,Math.hypot(t,e)<.5&&(this.x=h,this.y=s);let n=(1===a.guardForm?o+Math.PI/2:Math.atan2(s-this.y,h-this.x)+Math.PI/2)-this.drawAngle;for(;n<-Math.PI;)n+=2*Math.PI;for(;n>Math.PI;)n-=2*Math.PI;this.drawAngle+=.15*n}this.attackFrame=0,this.trail=[]}updateAttackMode(t,e,a){if(this.attackFrame++,this.attackFrame<this.attackDelay)return;let n=null,i=1/0;for(const a of t){const t=Math.hypot(a.x-e.x,a.y-e.y);t<i&&(i=t,n=a)}if(n){const t=n.x-this.x,e=n.y-this.y,i=Math.hypot(t,e)||1;if(this.vx+=t/i*10*a,this.vy+=e/i*10*a,this.vx*=.92,this.vy*=.92,this.x+=this.vx,this.y+=this.vy,this.drawAngle=Math.atan2(this.vy,this.vx)+Math.PI/2,Math.hypot(this.x-n.x,this.y-n.y)<n.r+(n.hasShield?10:0)){"shielded"===n.hit(this)&&(this.hp--,this.hp<=0?this.breakSword(a):(this.isStunned=!0,this.stunTimer=performance.now()+CONFIG.SWORD.STUN_DURATION_MS,this.vx=1.5*-this.vx+10*(Math.random()-.5),this.vy=1.5*-this.vy+10*(Math.random()-.5)))}this.trail.push({x:this.x,y:this.y}),this.trail.length>CONFIG.SWORD.TRAIL_LENGTH&&this.trail.shift()}}breakSword(t){this.isDead=!0,this.deathTime=performance.now(),this.respawnTimer=this.deathTime+CONFIG.SWORD.DEATH_WAIT_MS+CONFIG.SWORD.RESPAWN_DELAY_MS;const e=CONFIG.SWORD.SIZE*t,a=Math.cos(this.drawAngle),n=Math.sin(this.drawAngle);this.fragments.push({type:"handle",x:this.x,y:this.y,vx:.2*-this.vx+random(-1,1),vy:.2*-this.vy+random(-1,1),angle:this.drawAngle,va:random(-.1,.1)}),this.fragments.push({type:"mid",x:this.x+a*(.4*e)+n*(.4*e),y:this.y+n*(.4*e)-a*(.4*e),vx:.4*-this.vx+random(-2,2),vy:.4*-this.vy+random(-2,2),angle:this.drawAngle+random(-.2,.2),va:random(-.2,.2)}),this.fragments.push({type:"tip",x:this.x+a*(.8*e)+n*(.8*e),y:this.y+n*(.8*e)-a*(.8*e),vx:.6*-this.vx+random(-3,3),vy:.6*-this.vy+random(-3,3),angle:this.drawAngle+random(-.5,.5),va:random(-.4,.4)})}draw(t,e){if(this.isDead){if(this.fragments.length>0){const a=performance.now()-this.deathTime,n=CONFIG.SWORD.FRAGMENTS.LIFE_TIME,i=CONFIG.SWORD.FRAGMENTS.FADE_TIME,o=a>n?1-(a-n)/i:1;t.save(),t.globalAlpha=o,this.drawFragments(t,e),t.restore()}}else{if(this.trail.length>1){t.beginPath(),t.moveTo(this.trail[0].x,this.trail[0].y);for(let e=1;e<this.trail.length;e++)t.lineTo(this.trail[e].x,this.trail[e].y);t.strokeStyle=CONFIG.COLORS.SWORD_TRAIL,t.lineWidth=2*e,t.stroke()}t.save(),t.translate(this.x,this.y),t.rotate(this.drawAngle),this.drawAura(t,e),this.drawBlade(t,e),t.restore()}}drawFragments(t,e){const a=CONFIG.SWORD.SIZE*e,n=4*e;this.fragments.forEach(i=>{i.x+=i.vx,i.y+=i.vy,i.angle+=i.va,t.save(),t.translate(i.x,i.y),t.rotate(i.angle),t.shadowBlur=0,t.shadowColor="transparent",t.beginPath(),"handle"===i.type?(t.fillStyle=CONFIG.COLORS.SWORD_HANDLE,t.fillRect(-3*e,0,6*e,14*e),t.fillStyle=CONFIG.COLORS.SWORD_BLADE[2],t.moveTo(-n/2,0),t.lineTo(n/2,0),t.lineTo(n/2,.3*-a),t.lineTo(0,.2*-a),t.lineTo(-n/2,.35*-a),t.fill()):"mid"===i.type?(t.fillStyle=CONFIG.COLORS.SWORD_BLADE[1],t.moveTo(-n/2,0),t.lineTo(n/2,0),t.lineTo(n/2,.3*-a),t.lineTo(-n/2,.25*-a),t.fill()):"tip"===i.type&&(t.fillStyle=CONFIG.COLORS.SWORD_BLADE[0],t.moveTo(-n/2,0),t.lineTo(n/2,0),t.lineTo(0,.4*-a),t.fill()),t.restore()})}drawAura(t,e){const a=Math.floor(random(2,4));t.shadowColor=CONFIG.COLORS.SWORD_AURA_SHADOW,t.shadowBlur=8*e;for(let n=0;n<a;n++){t.beginPath();let a=-random(0,CONFIG.SWORD.SIZE*e),n=random(-3,3)*e;t.moveTo(n,a);for(let i=0;i<3;i++)n+=random(-4,4)*e,a+=random(-3,3)*e,t.lineTo(n,a);t.strokeStyle=`rgba(255,255,180,${random(.3,.6)})`,t.lineWidth=1.5*e,t.stroke()}}drawBlade(t,e){const a=CONFIG.SWORD.SIZE*e,n=4*e;t.shadowColor=CONFIG.COLORS.SWORD_GLOW_OUTER,t.shadowBlur=15*e;const i=t.createLinearGradient(0,-a,0,0);i.addColorStop(0,CONFIG.COLORS.SWORD_BLADE[0]),i.addColorStop(.5,CONFIG.COLORS.SWORD_BLADE[1]),i.addColorStop(1,CONFIG.COLORS.SWORD_BLADE[2]),t.fillStyle=i,t.beginPath(),t.moveTo(-n/2,0),t.lineTo(-n/2,-a),t.quadraticCurveTo(0,-a-10*e,n/2,-a),t.lineTo(n/2,0),t.fill(),t.shadowColor=CONFIG.COLORS.SWORD_GLOW_INNER,t.fillStyle=CONFIG.COLORS.SWORD_FRAGMENT,t.beginPath(),t.roundRect(-7*e,-1.2*e,14*e,2.4*e,2.4*e),t.fill(),t.fillStyle=CONFIG.COLORS.SWORD_HANDLE,t.beginPath(),t.moveTo(-3*e,0),t.lineTo(-2*e,14*e),t.lineTo(2*e,14*e),t.lineTo(3*e,0),t.fill()}}class StarField{constructor(t,e,a){this.stars=[];const n=CONFIG.BG.STAR_COUNT||t;for(let t=0;t<n;t++)this.stars.push({x:random(-e,2*e),y:random(-a,2*a),r:random(CONFIG.BG.STAR_SIZE.MIN,CONFIG.BG.STAR_SIZE.MAX),alpha:random(CONFIG.BG.STAR_ALPHA.MIN,CONFIG.BG.STAR_ALPHA.MAX)})}draw(t,e){t.shadowBlur=0;const a=CONFIG.BG.STAR_TWINKLE_SPEED;for(const n of this.stars)n.alpha+=random(-a,a),n.alpha>CONFIG.BG.STAR_ALPHA.MAX?n.alpha=CONFIG.BG.STAR_ALPHA.MAX:n.alpha<CONFIG.BG.STAR_ALPHA.MIN&&(n.alpha=CONFIG.BG.STAR_ALPHA.MIN),t.beginPath(),t.arc(n.x,n.y,n.r*e,0,2*Math.PI),t.fillStyle=`rgba(255,255,255,${n.alpha})`,t.fill()}}const canvas=document.getElementById("c"),ctx=canvas.getContext("2d",{alpha:!1});let width,height,scaleFactor=1,frameCount=0,lastTime=performance.now();const Camera={currentZoom:1,targetZoom:1,update(){this.currentZoom+=(this.targetZoom-this.currentZoom)*CONFIG.ZOOM.SMOOTH},adjustZoom(t){this.targetZoom=Math.max(CONFIG.ZOOM.MIN,Math.min(CONFIG.ZOOM.MAX,this.targetZoom+t))},screenToWorld(t,e){const a=width/2,n=height/2;return{x:(t-a)/this.currentZoom+a,y:(e-n)/this.currentZoom+n}}};function resize(){width=canvas.width=window.innerWidth,height=canvas.height=window.innerHeight,scaleFactor=width/CONFIG.CORE.BASE_WIDTH}window.addEventListener("resize",resize),resize();const Input={screenX:width/2,screenY:height/2,x:width/2,y:height/2,px:0,py:0,speed:0,isAttacking:!1,guardForm:1,attackTimer:null,isTouchDevice:"ontouchstart"in window||navigator.maxTouchPoints>0,mana:CONFIG.MANA.START||100,maxMana:CONFIG.MANA.MAX||100,lastManaRegenTick:performance.now(),initialPinchDist:0,lastFrameTime:performance.now(),exp:0,rankIndex:0,processActiveConsumption(t){let e=0;this.speed>1&&(e+=CONFIG.MANA.COST_MOVE_PER_SEC*t),this.isAttacking&&(e+=CONFIG.MANA.COST_ATTACK_PER_SEC*t),e>0&&(this.mana>0?this.updateMana(-e):this.isAttacking&&(this.isAttacking=!1,this.triggerManaShake()))},updateMana(t){this.mana=Math.max(0,Math.min(this.maxMana,this.mana+t)),this.renderManaUI()},regenMana(){const t=performance.now(),e=t-this.lastManaRegenTick;if(e>=CONFIG.MANA.REGEN_INTERVAL_MS){const a=Math.floor(e/CONFIG.MANA.REGEN_INTERVAL_MS);a>0&&(this.updateMana(a*CONFIG.MANA.REGEN_PER_MIN),this.lastManaRegenTick=t-e%CONFIG.MANA.REGEN_INTERVAL_MS)}},renderManaUI(){const t=document.getElementById("mana-bar"),e=document.getElementById("mana-text");if(t&&e){const a=this.mana/this.maxMana*100;t.style.width=a+"%",e.innerText=`Linh lực: ${Math.round(this.mana)}/${this.maxMana}`,a<20?t.classList.add("low-mana"):t.classList.remove("low-mana")}},triggerManaShake(){const t=document.getElementById("mana-container");t.classList.remove("mana-shake","mana-empty-error"),t.offsetWidth,t.classList.add("mana-shake","mana-empty-error"),setTimeout(()=>{t.classList.remove("mana-shake","mana-empty-error")},500)},updateExp(t){this.exp+=t,this.checkLevelUp(),this.renderExpUI()},checkLevelUp(){const t=CONFIG.CULTIVATION.RANKS[this.rankIndex];if(t&&this.exp>=t.exp){Math.random()<=t.chance?(this.exp-=t.exp,t.bonus&&(this.exp+=t.bonus),this.rankIndex++,console.log("Đột phá thành công: "+CONFIG.CULTIVATION.RANKS[this.rankIndex].name)):(this.exp=Math.max(0,this.exp-Math.floor(.1*t.exp)),this.triggerExpError())}},renderExpUI(){const t=CONFIG.CULTIVATION.RANKS[this.rankIndex];if(!t)return;const e=document.getElementById("exp-bar"),a=document.getElementById("exp-text"),n=document.getElementById("mana-bar"),i=document.getElementById("mana-bar-bg"),o=document.getElementById("cultivation-rank");a&&(a.innerText=`Kinh nghiệm: ${Math.floor(this.exp)}/${t.exp}`),o&&(o.innerText=t.name);const h=this.exp/t.exp*100;e&&(e.style.width=Math.min(100,h)+"%",e.style.background=`linear-gradient(90deg, ${t.lightColor}, ${t.color})`,e.style.boxShadow=`0 0 10px ${t.lightColor}`),n&&(n.style.backgroundColor=t.color,n.style.boxShadow=`0 0 15px ${t.color}`),i&&(i.style.borderColor=t.color),o&&(o.style.color=t.color,o.style.textShadow=`0 0 8px ${t.color}80`)},triggerExpError(){const t=document.getElementById("exp-container");t.classList.add("shake-red"),setTimeout(()=>t.classList.remove("shake-red"),500)},update(t){const e=Camera.screenToWorld(this.screenX,this.screenY);this.x=e.x,this.y=e.y,this.speed=Math.hypot(this.x-this.px,this.y-this.py),this.px=this.x,this.py=this.y,this.processActiveConsumption(t)},handleMove(t){if(t.target.closest(".btn"))return;const e=t.touches?t.touches[0]:t;this.screenX=e.clientX,this.screenY=e.clientY},handleDown(t){t.target.closest(".btn")||this.isTouchDevice||(t.preventDefault(),this.attackTimer=setTimeout(()=>{this.isAttacking=!0},CONFIG.SWORD.ATTACK_DELAY_MS))},handleUp(t){this.isTouchDevice||(this.isAttacking=!1,clearTimeout(this.attackTimer))},handleWheel(t){const e=-t.deltaY*CONFIG.ZOOM.SENSITIVITY;Camera.adjustZoom(e)}};window.addEventListener("pointermove",t=>{t.touches||Input.handleMove(t)}),window.addEventListener("pointerdown",t=>Input.handleDown(t)),window.addEventListener("pointerup",t=>Input.handleUp(t)),window.addEventListener("wheel",t=>{Camera.adjustZoom(-t.deltaY*CONFIG.ZOOM.SENSITIVITY)},{passive:!1}),window.addEventListener("keydown",t=>{"+"!==t.key&&"="!==t.key||Camera.adjustZoom(CONFIG.ZOOM.STEP),"-"!==t.key&&"_"!==t.key||Camera.adjustZoom(-CONFIG.ZOOM.STEP)}),window.addEventListener("touchstart",t=>{2===t.touches.length&&(Input.initialPinchDist=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY))},{passive:!1}),window.addEventListener("touchmove",t=>{if(2===t.touches.length){t.preventDefault();const e=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY),a=.01*(e-Input.initialPinchDist);Camera.adjustZoom(a),Input.initialPinchDist=e}else Input.handleMove(t)},{passive:!1}),document.getElementById("btn-form").addEventListener("pointerdown",t=>{t.stopPropagation(),t.preventDefault();const e=CONFIG.MANA.COST_CHANGE_FORM;if(Input.mana>=e){Input.updateMana(-e),Input.guardForm=1===Input.guardForm?2:1;const a=t.currentTarget.querySelector(".icon-form");a&&(a.style.transform=`rotate(${1===Input.guardForm?-15:165}deg)`)}else Input.triggerManaShake()});const attackBtn=document.getElementById("btn-attack"),startAttack=t=>{t.stopPropagation(),t.preventDefault();const e=swords.filter(t=>!t.isDead).length;if(Input.mana<=0&&0===e)return Input.triggerManaShake(),void(Input.isAttacking=!1);Input.isAttacking=!0},stopAttack=t=>{t.stopPropagation(),t.preventDefault(),Input.isAttacking=!1,Input.attackTimer&&clearTimeout(Input.attackTimer)};attackBtn.addEventListener("pointerdown",startAttack),attackBtn.addEventListener("pointerup",stopAttack),attackBtn.addEventListener("pointerleave",stopAttack);const enemies=[],swords=[];let starField;const guardCenter={x:width/2,y:height/2,vx:0,vy:0};function init(){Input.renderManaUI(),Input.renderExpUI(),starField=new StarField(250,width,height);for(let t=0;t<CONFIG.ENEMY.SPAWN_COUNT;t++)enemies.push(new Enemy);for(let t=0;t<CONFIG.SWORD.COUNT;t++)swords.push(new Sword(t,scaleFactor))}function updateSwordCounter(t){const e=t.filter(t=>!t.isDead).length,a=t.length,n=document.getElementById("sword-count-text");n&&(n.innerText=`${e}/${a}`,n.style.color=e<.3*a?"#ff4444":"#fff")}function updatePhysics(t){Camera.update(),Input.update(t),Input.regenMana();let e=Input.x-guardCenter.x,a=Input.y-guardCenter.y;guardCenter.vx+=.04*e,guardCenter.vy+=.04*a,guardCenter.vx*=.82,guardCenter.vy*=.82,guardCenter.x+=guardCenter.vx,guardCenter.y+=guardCenter.vy}function renderCursor(){ctx.shadowBlur=10,ctx.shadowColor="#6fffe0",ctx.beginPath(),ctx.arc(Input.x,Input.y,4*scaleFactor,0,2*Math.PI),ctx.fillStyle="#6fffe0",ctx.fill(),ctx.shadowBlur=0}function animate(){const t=performance.now(),e=(t-lastTime)/1e3;lastTime=t,frameCount++,ctx.fillStyle=CONFIG.COLORS.BG_FADE,ctx.fillRect(0,0,width,height),updatePhysics(e),frameCount%10==0&&updateSwordCounter(swords),ctx.save(),ctx.translate(width/2,height/2),ctx.scale(Camera.currentZoom,Camera.currentZoom),ctx.translate(-width/2,-height/2),starField.draw(ctx,scaleFactor),ctx.save(),ctx.translate(guardCenter.x,guardCenter.y),ctx.rotate(2e-4*performance.now()),ctx.strokeStyle="rgba(120,255,210,0.1)",ctx.lineWidth=1.5*scaleFactor,ctx.beginPath(),ctx.arc(0,0,50*scaleFactor,0,2*Math.PI),ctx.stroke(),ctx.restore(),enemies.forEach(t=>t.draw(ctx,scaleFactor)),swords.forEach(t=>{t.update(guardCenter,enemies,Input,scaleFactor),t.draw(ctx,scaleFactor)}),renderCursor(),ctx.restore(),requestAnimationFrame(animate)}init(),animate();